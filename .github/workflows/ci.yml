name: hAIrem CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install linters
        run: pip install ruff mypy types-PyYAML pydantic --break-system-packages
      - name: Ruff
        run: ruff check apps/h-core/src apps/h-bridge/src
      - name: Mypy h-core
        run: mypy apps/h-core/src --ignore-missing-imports
        continue-on-error: true

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install pydantic PyYAML watchdog redis httpx aiohttp python-dotenv \
                      pytest pytest-asyncio anyio --break-system-packages
      - name: Unit tests
        run: |
          cd apps/h-core
          python3 -m pytest tests/ -m "not integration" -q --tb=short
        env:
          PYTHONPATH: .

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install pydantic PyYAML watchdog redis httpx aiohttp python-dotenv \
                      pytest pytest-asyncio anyio --break-system-packages
      - name: Integration tests (Redis-backed)
        run: |
          cd apps/h-core
          python3 -m pytest tests/ -m "integration" -q --tb=short --ignore=tests/test_surrealdb.py
        env:
          PYTHONPATH: .
          TEST_REDIS_HOST: localhost
        continue-on-error: true

  docker-build:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - name: Docker Compose build
        run: docker compose build --quiet
