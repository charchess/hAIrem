# Requirements Traceability Matrix - Story 9.2: Privacy Filter Middleware

**Date:** 2026-01-23
**Story:** 9.2 - Privacy Filter Middleware

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: A new `PrivacyFilter` utility is implemented in `apps/h-core/src/utils/privacy.py`.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/utils/privacy.py`
  - Given: The file exists
  - When: Examining content
  - Then: `PrivacyFilter` class is present with `redact` method.

#### AC2: The filter supports redaction of common sensitive patterns (Regex, Context, Entropy).

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `apps/h-core/tests/test_privacy.py`
  - Given: Various sensitive inputs (Google Keys, IP, "password: 123", high entropy string)
  - When: `redact()` called
  - Then: All secrets are replaced by `[REDACTED]` and detected types are returned.

#### AC3: The filter is applied in `main.py` before SurrealDB persistence or embedding generation.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/main.py`
  - Given: Background tasks `persist_with_embedding` and `persist_ui_with_embedding`
  - When: Executing tasks
  - Then: `privacy_filter.redact(text)` is called *before* `llm_client.get_embedding` and `surreal_client.insert_message`.

#### AC4: A `SYSTEM_LOG` (Warning) is broadcasted whenever a redaction occurs.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/main.py`
  - Given: Detection returned by filter
  - When: `if detected:` block entered
  - Then: `logger.warning(f"PRIVACY: Redacted ...")` is called, which is automatically broadcasted as `SYSTEM_LOG` via `RedisLogHandler`.

#### AC5: Unit tests verify successful redaction.

**Coverage: FULL**

Given-When-Then Mappings:

- **Execution**: `PYTHONPATH=. pytest tests/test_privacy.py`
  - Given: Redaction scenarios
  - When: Tests run
  - Then: 4 tests pass (Regex, Context, Entropy, No Redaction).

### Risk Assessment

- **Low Risk**: The triple-layered approach (Regex + Context + Entropy) offers high coverage.
