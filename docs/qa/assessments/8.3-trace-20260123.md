# Requirements Traceability Matrix - Story 8.3: Vector Embeddings & Semantic Search (RAG)

**Date:** 2026-01-23
**Story:** 8.3 - Vector Embeddings & Semantic Search (RAG)

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: The `LlmClient` supports generating vector embeddings using LiteLLM.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/infrastructure/llm.py::get_embedding`
  - Given: `LlmClient` initialized with `gemini/` prefix
  - When: `get_embedding("text")` is called
  - Then: `aembedding` is invoked and returns a 768-dim (Gemini) or 1536-dim (OpenAI) vector.

#### AC2: SurrealDB is configured with a vector index on the `messages` collection.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/infrastructure/surrealdb.py::setup_schema`
  - Given: Orchestrator connecting to SurrealDB
  - When: `connect()` succeeds
  - Then: `DEFINE INDEX mt_embedding ... MTREE ...` is executed automatically.

#### AC3: Every new message is automatically embedded and stored with its vector representation.

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Check**: `tests/validate_epic_8_e2e.py`
  - Given: A message sent via UI
  - When: Examining SurrealDB record
  - Then: Record contains a non-null `embedding` field (Confirmed via success logs).

#### AC4: A new tool `recall_memory(query)` is available to agents.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/domain/agent.py::recall_memory`
  - Given: Agent initialization
  - When: `_setup_default_tools()` called
  - Then: `recall_memory` tool is registered and available in the `tools` schema.

#### AC5: Search results are filtered by agent relevance or globally.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/infrastructure/surrealdb.py::semantic_search`
  - Given: Search query embedding
  - When: Querying database
  - Then: Returns top K records ordered by `vector::distance::cosine`.

### Risk Assessment

- **Low Risk**: Resolved provider-specific prefix issue for Gemini embeddings. System is now stable.
