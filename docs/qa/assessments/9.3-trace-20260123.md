# Requirements Traceability Matrix - Story 9.3: The Sleep Cycle

**Date:** 2026-01-23
**Story:** 9.3 - The Sleep Cycle (Cognitive Consolidation)

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 7 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: A new service `MemoryConsolidator` is implemented in `apps/h-core/src/domain/memory.py`.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/domain/memory.py`
  - Given: The file exists
  - When: Examining content
  - Then: `MemoryConsolidator` class is present with `consolidate` method.

#### AC2: A manual trigger is available via `POST /api/memory/consolidate`.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/main.py`
  - Given: FastAPI app running
  - When: Examining routes
  - Then: `@app.post("/api/memory/consolidate")` is defined and calls `memory_consolidator.consolidate()`.

#### AC3: The process retrieves messages that haven't been processed yet.

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `apps/h-core/tests/test_memory.py::test_memory_consolidation_success`
  - Given: A mix of processed and unprocessed messages in SurrealDB
  - When: `consolidate()` called
  - Then: `mock_surreal.get_unprocessed_messages` is invoked.

#### AC4: An LLM call is used to extract a list of "Atomic Facts".

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/domain/memory.py::consolidate`
  - Given: A conversation chunk
  - When: Processing batch
  - Then: `llm_client.get_completion` is called with the `CONSOLIDATION_PROMPT`.

#### AC5: Extracted facts are stored in a new SurrealDB collection `memories`.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/infrastructure/surrealdb.py::insert_memory`
  - Given: Extracted fact data
  - When: `insert_memory()` called
  - Then: `client.create("memories", ...)` is executed.

#### AC6: Messages processed are updated in SurrealDB with `processed: true`.

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `apps/h-core/src/infrastructure/surrealdb.py::mark_as_processed`
  - Given: Batch of message IDs
  - When: `mark_as_processed()` called
  - Then: `UPDATE messages:... SET processed = true` is executed for each ID.

#### AC7: A `SYSTEM_LOG` (Info) is broadcasted summarizing results.

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `apps/h-core/tests/test_memory.py::test_memory_consolidation_success`
  - Given: Successful extraction
  - When: Cycle completes
  - Then: `mock_redis.publish` is called with a summary log.

### Risk Assessment

- **Low Risk**: The state-based approach (processed flag) ensures no data is processed twice and allows for easy resumes after failure.
