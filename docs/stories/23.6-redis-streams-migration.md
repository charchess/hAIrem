# Story 23.6: Migration to Redis Streams for Cognitive Stimuli

Status: review
Epic: 23 - H-Core Refactoring

## Story
**As a** System,
**I want** to use Redis Streams instead of Pub/Sub for all critical agent stimuli,
**so that** no message is lost during transient disconnections and agents can recover their state.

## Acceptance Criteria
1. **Stream Transition:**
    - Replace `rc.subscribe("broadcast")` with `rc.listen_stream("system_stream", ...)` in the Orchestrator.
2. **Persistence:**
    - All narrative text, visual assets, and expert responses must be added to the stream via `xadd`.
3. **Consumer Groups:**
    - Use a unique consumer group for each core service (H-Core, H-Bridge) to ensure reliable delivery.
4. **Acknowledgement:**
    - Messages must be explicitly acknowledged (XACK) only after successful processing.

## Tasks
- [x] Refactor `HaremOrchestrator` to use `listen_stream`.
- [x] Update `RedisLogHandler` to use streams (optional but recommended).
- [x] Update `H-Bridge` to use `listen_stream` for relaying messages to UI.
- [x] Add integration test for stream recovery (XACK validation).

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Completion Notes List
- Migrated H-Core and H-Bridge to use Redis Streams instead of Pub/Sub.
- Implemented Consumer Groups ('h-core', 'h-bridge-discovery', 'h-bridge-ui') for reliable delivery.
- Verified system stability with Playwright E2E tests.
