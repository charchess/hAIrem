# Story 13.2: The Decay Algorithm (Forgetting)

**Status:** InProgress

## Story
**As a** Product Owner,
**I want** unused memories to slowly fade away (lower confidence),
**so that** the agents focus on relevant, recent, or reinforced information, simulating a living memory.

## Acceptance Criteria
1. **Decay Metadata:**
    - Every `BELIEVES` edge must have a `strength` field (0.0 to 1.0) and a `last_accessed` datetime.
2. **Algorithm Implementation:**
    - Implement a background process (or API trigger) that applies a decay function: `new_strength = old_strength * exp(-decay_rate * time_delta)`.
    - If `strength` falls below a threshold (e.g., 0.1), the edge is deleted or archived (Forgetting).
3. **Reinforcement:**
    - When a memory is successfully recalled via `recall_memory`, its `strength` must be boosted and `last_accessed` updated to current time.

## Tasks / Subtasks
- [x] Implement `apply_decay(decay_rate: float)` in `MemoryConsolidator` (AC: #2)
    - [x] Calculate time difference between current time and `last_accessed`.
    - [x] Update `strength` for all `BELIEVES` edges.
    - [x] Clean up (DELETE) edges with `strength < 0.1`.
- [x] Add `update_memory_strength(edge_id, boost: bool)` in `SurrealDbClient` (AC: #3)
    - [x] Update `last_accessed`.
    - [x] Apply boost logic if `boost=True`.
- [x] Integrate reinforcement into `BaseAgent.recall_memory()` (AC: #3)
    - [x] Call `update_memory_strength` for each retrieved fact.
- [x] Configure `DECAY_RATE` in `.env`.

## Dev Notes
- **Mathematical Model:** Exponential decay is preferred for natural feel.
- **SurrealDB Query:** `UPDATE BELIEVES SET strength = strength * 0.95, last_accessed = time::now() WHERE last_accessed < time::now() - 1d`.
- **Note:** Don't delete the `fact` node itself, only the `BELIEVES` relationship from the agent. Other agents might still believe it.

## Testing
- **Test file location:** `apps/h-core/tests/test_decay.py`
- **Framework:** `pytest`
- **Scenarios:**
    - Verify `strength` decreases after simulated time passage.
    - Verify `recall_memory` resets/boosts strength.
    - Verify edges are deleted when strength is too low.

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `apps/h-core/tests/test_decay.py` passed.

### Completion Notes List
- Implemented `update_memory_strength` and `apply_decay_to_all_memories` in `SurrealDbClient`.
- Added `apply_decay` method to `MemoryConsolidator` to trigger global forgetting.
- Integrated memory reinforcement in `BaseAgent.recall_memory()` so that recalled facts are strengthened.
- Configured `DECAY_RATE` in `.env`.
- Verified logic with unit tests.

### File List
- `apps/h-core/src/infrastructure/surrealdb.py`
- `apps/h-core/src/domain/memory.py`
- `apps/h-core/src/domain/agent.py`
- `.env`
- `apps/h-core/tests/test_decay.py`

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Initial draft for Decay Algorithm | Bob (SM) |
| 2026-01-25 | 1.1 | Implemented Decay and Reinforcement logic | James (Dev) |

## QA Results

### Review Date: 2026-01-26
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
L'implémentation de l'algorithme de decay est mathématiquement saine et utilise correctement les fonctions natives de SurrealDB (`math::exp`). La distinction entre la suppression de la relation (`BELIEVES`) et la conservation du fait (`fact`) est une décision architecturale clé qui préserve l'intégrité du graphe.

### Compliance Check
- Coding Standards: [✓] Requêtes SurrealDB asynchrones.
- Project Structure: [✓] Logique répartie entre infrastructure et domaine.
- Testing Strategy: [✓] Tests unitaires couvrant le decay et le boost.
- All ACs Met: [✓]

### Gate Status
Gate: PASS → docs/qa/gates/13.2-decay-algorithm.yml
Risk profile: Low (Configurable via ENV)

### Recommended Status
**Status:** Done

## Status
Done
