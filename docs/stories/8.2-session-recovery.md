# Story 8.2: Session History Recovery

**Status:** Done
**Epic:** 8 - Persistent Memory (The Archive)

## Story
**As a** User,
**I want** my chat history to be restored automatically when I reload the page or open a new session,
**so that** I can maintain context and continuity in my interactions with the agents.

## Acceptance Criteria
1. [x] A new API endpoint `GET /api/history` is available in `apps/h-core/src/main.py`.
2. [x] The endpoint retrieves the last 50 messages from the SurrealDB `messages` collection, ordered by timestamp.
3. [x] The `NetworkClient` in `apps/a2ui/js/network.js` fetches this history during initialization.
4. [x] The `Renderer` in `apps/a2ui/js/renderer.js` correctly renders historical messages in the chat history container without triggering narrative animations (typewriter).
5. [x] Historical messages are visually distinguishable or simply loaded in the correct chronological order.

## Tasks / Subtasks
- [x] Backend: Data Retrieval (AC: #1, #2)
    - [x] Implement `get_messages(limit=50)` in `apps/h-core/src/infrastructure/surrealdb.py`.
    - [x] Create the FastAPI route `GET /api/history`.
    - [x] Ensure messages are returned in a format compatible with `HLinkMessage`.
- [x] Frontend: History Loading (AC: #3, #4)
    - [x] Update `network.js` to call the history API on startup.
    - [x] Implement `renderHistory(messages)` in `renderer.js`.
    - [x] Ensure historical messages are added to the DOM immediately (no streaming/typing effect for old data).
- [x] Integration: End-to-End verification (AC: #5)
    - [x] Send messages, refresh page, and verify they persist in the UI.

## Dev Notes
- **API Specification**: The response should be a list of `HLinkMessage` objects. [Source: architecture/5-protocole-h-link.md]
- **Previous Story Insights**: Requires Story 8.1 (SurrealDB Integration) to be functional. Fixed SurrealDB 2.x result parsing.
- **File Locations**: `main.py` for the route, `network.js` for the fetch, `renderer.js` for rendering.

## Testing
- [x] Verified with Playwright E2E test `tests/validate_8_2.py`.
- [x] Validated chronological order and persistence on refresh.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Initial draft for History Recovery | Bob (SM) |
| 2026-01-23 | 1.1 | Implementation completed and validated | James (Dev) |

## Dev Agent Record
- **Agent Model Used**: Gemini 2.0 Flash
- **Debug Log References**: [N/A]
- **Completion Notes List**:
    - [History recovery endpoint implemented]
    - [Frontend integrated with fetch/render logic]
    - [E2E validation passed]
- **File List**:
    - `apps/h-core/src/main.py`
    - `apps/h-core/src/infrastructure/surrealdb.py`
    - `apps/a2ui/js/network.js`
    - `apps/a2ui/js/renderer.js`
    - `tests/validate_8_2.py`

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation effectively solves the session continuity problem. The developer optimized the SurrealDB query result handling for the newer Python client version. The UI rendering is efficient and correctly bypasses narrative effects for historical data.

### Refactoring Performed
None required. The implementation followed the proposed subtasks correctly.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (E2E persistence validated)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Implemented history API
- [x] Integrated bulk history rendering in UI
- [x] Validated persistence across reloads
- [ ] Add `message.id` duplicate check in UI to prevent race condition duplicates

### Gate Status
Gate: PASS → docs/qa/gates/8.2-session-recovery.yml
Risk profile: docs/qa/assessments/8.2-risk-20260123.md
NFR assessment: docs/qa/assessments/8.2-nfr-20260123.md
Trace matrix: docs/qa/assessments/8.2-trace-20260123.md

### Recommended Status
[✓ Ready for Done]
