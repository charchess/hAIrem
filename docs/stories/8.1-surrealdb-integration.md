# Story 8.1: Memory Infrastructure & SurrealDB Integration

**Status:** Done
**Epic:** 8 - Persistent Memory (The Archive)

## Story
**As a** Developer,
**I want** to integrate SurrealDB into the H-Core orchestrator,
**so that** all H-Link messages and agent states can be persisted for long-term memory and retrieval.

## Acceptance Criteria
1. [ ] A dedicated SurrealDB client is implemented in `apps/h-core/src/infrastructure/surrealdb.py`.
2. [ ] The client supports connecting to a SurrealDB instance with environment-based configuration.
3. [ ] All incoming and outgoing `HLinkMessage` objects are automatically persisted in a `messages` collection.
4. [ ] The system handles connection failures gracefully with retry logic (similar to the Redis client).
5. [ ] Basic unit tests verify the CRUD operations for H-Link messages in SurrealDB.

## Tasks / Subtasks
- [ ] Backend: Implement `SurrealDbClient` (AC: #1, #2, #4)
    - [ ] Create `apps/h-core/src/infrastructure/surrealdb.py`.
    - [ ] Use `surrealdb` Python library (asynchronous).
    - [ ] Implement `connect()`, `disconnect()`, and `insert_message()` methods.
    - [ ] Add exponential backoff for reconnection. [Source: infrastructure/redis.py]
- [ ] Backend: Integrate persistence into `main.py` (AC: #3)
    - [ ] Initialize `surreal_client` in the FastAPI app.
    - [ ] Add a middleware or update WebSocket/Redis handlers to save every message.
- [ ] Testing: Create validation tests (AC: #5)
    - [ ] Create `apps/h-core/tests/test_surrealdb.py`.
    - [ ] Mock SurrealDB responses for unit tests.

## Dev Notes
- **Data Models**: Use the existing `HLinkMessage` pydantic model for serialization. [Source: architecture/5-protocole-h-link.md]
- **Tech Stack**: SurrealDB is the primary "Hot" database for graph/vector memory. [Source: architecture/3-tech-stack.md]
- **Coding Standards**: Asynchronous implementation is mandatory. [Source: architecture/9-coding-standards.md]
- **File Locations**: `apps/h-core/src/infrastructure/` for the client, `apps/h-core/src/main.py` for integration.

## Testing
- Test file location: `apps/h-core/tests/`
- Framework: `pytest`
- Patterns: Use `unittest.mock` for external DB dependencies.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Initial draft for Epic 8.1 | Bob (SM) |

## Dev Agent Record
- **Agent Model Used**: [Pending]
- **Debug Log References**: [Pending]
- **Completion Notes List**: [Pending]
- **File List**: [Pending]

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation is solid. The developer successfully navigated several technical hurdles with the `surrealdb` Python library, ultimately delivering a robust, non-blocking persistence layer. The choice to use the message UUID as the record ID (with backtick escaping) is excellent for traceability.

### Refactoring Performed
- **File**: `apps/h-core/src/infrastructure/surrealdb.py`
  - **Change**: Switched to `AsyncSurreal` and manual `__aenter__` call.
  - **Why**: Standard `Surreal` class was initializing in synchronous blocking mode.
  - **How**: Used the explicit async client provided by the library.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Direct data verification successful)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Implemented SurrealDbClient
- [x] Fixed UUID parsing bug in record IDs
- [x] Verified data persistence in memory store
- [ ] Implement data encryption at rest for sensitive memories (V3)

### Gate Status
Gate: PASS → docs/qa/gates/8.1-surrealdb-integration.yml
Risk profile: docs/qa/assessments/8.1-risk-20260123.md
NFR assessment: docs/qa/assessments/8.1-nfr-20260123.md
Trace matrix: docs/qa/assessments/8.1-trace-20260123.md

### Recommended Status
[✓ Ready for Done]
