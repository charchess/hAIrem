# Story 13.1: Migration vers le Schéma de Graphe Subjectif

Status: ready-for-dev

## Story

As a System Architect,
I want to implement a true Graph database schema in SurrealDB,
so that memories are not just isolated documents but connected nodes representing the richness of a mental model.

## Acceptance Criteria

1. **Given** une base SurrealDB vide ou existante.
2. **When** le schéma est appliqué.
3. **Then** les tables de noeuds `fact`, `subject` et `concept` sont créées en mode `SCHEMAFULL`.
4. **And** les tables d'arêtes `BELIEVES`, `ABOUT` et `CAUSED` sont créées avec des contraintes d'intégrité.
5. **And** l'arête `BELIEVES` contient les champs `confidence`, `strength` (0.0-1.0) et `last_accessed` (datetime).
6. **And** des index sont créés sur `strength` et `last_accessed` pour optimiser le decay et le recall.
7. **And** un script de migration permet de transformer les données "plates" existantes en structure de graphe.

## Tasks / Subtasks

- [ ] Task 1: Définir le schéma SurQL (AC: 3, 4, 5, 6)
  - [ ] Créer `apps/h-core/src/infrastructure/graph_schema.surql`.
  - [ ] Implémenter les `DEFINE TABLE` et `DEFINE FIELD` pour tous les noeuds et arêtes.
  - [ ] Ajouter les index de performance sur les arêtes `BELIEVES`.
- [ ] Task 2: Mettre à jour le client SurrealDB (AC: 4, 5)
  - [ ] Modifier `apps/h-core/src/infrastructure/surrealdb.py` pour supporter les requêtes `RELATE`.
  - [ ] Implémenter une méthode `insert_graph_memory(fact_data)` gérant la création atomique des noeuds et des liens.
- [ ] Task 3: Script de Migration (AC: 7)
  - [ ] Créer `scripts/migrate_memories_v2_to_v3.py`.
  - [ ] Parser les anciennes "memories" et les rattacher à `subject:system` ou aux agents via `BELIEVES`.
- [ ] Task 4: Validation technique
  - [ ] Créer `tests/test_graph_migration.py` pour vérifier l'intégrité du graphe après migration.

## Dev Notes

- **Performance :** L'utilisation de `SCHEMAFULL` est impérative pour garantir la cohérence des relations cognitives.
- **Indexation :** Ne pas oublier d'indexer le champ `embedding` si possible (Vector Index) pour la recherche sémantique.
- **Syntaxe :** Utiliser `RELATE subject:lisa->BELIEVES->fact:uuid SET strength = 1.0;`.

### Project Structure Notes

- **Migration :** Le script doit être capable de tourner dans le conteneur `h-core` ou via une commande `docker exec`.
- **Infrastructure :** Toutes les queries SurQL doivent être centralisées dans le dossier `infrastructure`.

### References

- [Source: docs/architecture/4-modles-de-donnes-mmoire-subjective.md#4.1 Architecture du Graphe]
- [Source: docs/prd-v4.md#2. Les Trois Piliers]

## Dev Agent Record

### Agent Model Used

Gemini 2.0 Flash

### Debug Log References

### Completion Notes List

### File List
