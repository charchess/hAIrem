# Story 25.4: Consistance Personnage & Character Vault

**Status:** Ready for Review
**Epic:** 25 - Visual Imagination

## Story
**As a** Developer,
**I want** to use reference images for agent generations,
**so that** characters maintain visual consistency across all generated assets.

## Acceptance Criteria
1. **Character Vault Setup:**
    - Establish the folder structure `agents/{agent_id}/media/` for each agent. [Source: architecture/13-visual-imagination.md#3]
2. **Reference Image Integration:**
    - The `VisualImaginationService` must automatically pull `character_sheet_neutral.png` when generating an image for a specific agent.
3. **API Payload Support:**
    - Pass the reference image as `reference_image` in the `NanoBananaProvider.generate` call. [Source: Story 25.1 AC]
4. **Consistency Validation:**
    - Verify (manually or via logs) that the `agent_id` is correctly mapped to its corresponding reference image.

## Dev Notes

### Previous Story Insights
- `NanoBananaProvider` already supports the `reference_image` parameter in its `generate` method.

### Data & Files
- Path: `agents/{agent_id}/media/character_sheet_neutral.png`
- If the file is missing, fallback to no reference image and log a warning.

### File Locations
- Core logic update in `apps/h-core/src/services/visual/manager.py` or a new `VisualImaginationService`.

### Testing Requirements
- Mock file existence to test fallback vs. usage of reference image.
- Verify that the `reference_image_used` field is correctly populated in SurrealDB.

## Tasks / Subtasks

- [x] **Vault Infrastructure** (AC: 1)
    - [x] Ensure `agents/` subdirectories have a `media/` folder.
    - [x] Create a sample `character_sheet_neutral.png` (placeholder) for testing LISA.
- [x] **Reference Resolution Logic** (AC: 2)
    - [x] Implement `get_agent_reference_image(agent_id)` which returns the path/base64 of the character sheet.
- [x] **Integration with Generator** (AC: 3)
    - [x] Update the generation flow to inject the reference image if available.
- [x] **DB Metadata Update** (AC: 4)
    - [x] Ensure the `visual_asset` record in SurrealDB includes the `reference_image_used`.

## Dev Agent Record

### Agent Model Used
Gemini 2.5 Flash

### Debug Log
- Created `media/` folders for all agents.
- Implemented `VisualImaginationService` to handle reference image resolution and generation coordination.
- Added base64 encoding for reference images to support API payloads.
- Verified that `reference_image_used` is correctly tracked in metadata.
- All tests passed.

### Completion Notes List
- Character Vault infrastructure established at `agents/{agent_id}/media/`.
- `VisualImaginationService.get_agent_reference_image` handles character sheet resolution with fallback.
- Generation flow updated to inject `reference_image` into provider calls.
- Metadata indexing includes `reference_image_used` for SurrealDB traceability.

### File List
- `apps/h-core/src/services/visual/service.py` (New)
- `apps/h-core/tests/test_visual_service.py` (New)
- `agents/electra/media/` (New Dir)
- `agents/entropy/media/` (New Dir)
- `agents/lisa/media/` (New Dir + placeholder)
- `agents/renarde/media/` (New Dir)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-27 | 1.0 | Initial draft for Story 25.4 | Bob (SM) |
| 2026-01-27 | 1.1 | Implemented VisualImaginationService and Vault infrastructure | James (Dev) |

### Status
**Status:** Ready for Review

## QA Results

### Quality Gate Decision: PASS ðŸ§ª

**Review Date:** 2026-01-28
**Reviewer:** Quinn (QA)

#### Analysis:
The transition to self-contained personas in `agents/[name]/persona.yaml` has made the character vault truly pluggable. Consistency is maintained via reference image injection.

#### Gate Decision File:
`docs/qa/gates/25.4-character-consistency.yml`

#### Status
[âœ“ Done]

