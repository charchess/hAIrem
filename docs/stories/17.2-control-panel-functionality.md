# Story 17.2: Control Panel Functionality (Log & Config)

**Status:** Done
**Epic:** 17 - "The Stage" UI/UX Overhaul

## Story
**As a** System Administrator,
**I want** to configure system behavior (like logs) from the UI,
**so that** I can debug issues without editing environment files or restarting containers.

## Acceptance Criteria
1. **Log Level Control:**
    - Add a visual selector (Dropdown or Slider) in the Admin Panel for Log Levels: `DEBUG`, `INFO`, `WARNING`, `ERROR`.
    - Changing this value must send a `system.config_update` command to the backend via WebSocket.
    - The backend `RedisLogHandler` must update its filtering dynamically.
2. **System Health Monitor:**
    - Move the existing connection status indicators (WS, Redis, LLM) from the header to the Admin Panel.
    - Display latency stats if available.
3. **Persisted Config:**
    - The UI should remember the last set log level (Local Storage or Backend State).

## Tasks / Subtasks
- [x] Backend: Update `main.py` to handle `system.config_update` message type.
- [x] Backend: Make `RedisLogHandler` level dynamic (not just env var).
- [x] Frontend: Build Admin Panel UI (HTML/CSS).
- [x] Frontend: Implement `sendConfigUpdate()` in `network.js` (integrated via generic `send`).

## Dev Notes
- **Message Type:** Use `type: "system.config_update", payload: { log_level: "DEBUG" }`.
- **Target:** `agent:system` (or broadcast if simpler).

## Testing
- **Scenarios:**
    - Open Admin Panel -> Change Log Level to ERROR.
    - Verify INFO logs stop appearing in the log viewer.
    - Change back to INFO. Verify logs resume.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Initial draft for Control Panel | Bob (SM) |
| 2026-01-26 | 1.1 | Implemented Control Panel logic | James (Dev) |

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `tests/validate_17_2.py` passed.

### Completion Notes List
- Added dynamic log level support to `RedisLogHandler` in `main.py`.
- Implemented `system.config_update` handler in WebSocket loop.
- Built Admin Panel UI with Log Level select and mirrored system health indicators.
- Added persistent log level choice via LocalStorage.

### File List
- `apps/h-core/src/main.py`
- `apps/a2ui/index.html`
- `apps/a2ui/style.css`
- `apps/a2ui/js/renderer.js`
- `tests/validate_17_2.py`

## QA Results

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation of the System Control Panel is robust and well-integrated into the existing event-driven architecture. The backend `RedisLogHandler` correctly handles dynamic log level updates without requiring a service restart. The frontend navigation between panels is fluid, and the health indicators provide good visibility into system state. 

One minor concern is the lack of multi-client synchronization for the UI state of the log level selector (if client A changes it, client B's dropdown remains unchanged until reload or manual sync), though the backend filtering correctly applies to all.

### Refactoring Performed

- **File**: `apps/h-core/src/main.py`
  - **Change**: Moved `level_map` to `__init__` and added validity checks for `log_level`.
  - **Why**: Optimization (prevent re-allocation on every log emit) and robustness (prevent invalid levels from affecting state).
  - **How**: Initialized `self.level_map` in constructor; used `.upper()` and membership check in `set_level`.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

- [x] Backend: Implement dynamic filtering in `RedisLogHandler`
- [x] Backend: Add health check broadcast loop
- [x] Frontend: Implement Admin Panel with persistent log level choice
- [x] Frontend: Synchronize log level on WebSocket connection
- [x] Backend: Optimize `RedisLogHandler` level mapping
- [ ] Add unit tests for `RedisLogHandler` level transitions (suggested for Sprint 8)
- [ ] Implement multi-client UI state synchronization for config updates

### Security Review

No immediate security concerns. The control panel is currently accessible to all users. Future implementation of RBAC is recommended for production environments.

### Performance Considerations

The `health_check_loop` runs every 30 seconds, providing a good balance between observability and resource usage. Log level filtering is highly efficient after refactoring.

### Files Modified During Review

- `apps/h-core/src/main.py`
- `docs/stories/17.2-control-panel-functionality.md`

### Gate Status

Gate: PASS → docs/qa/gates/17.2-control-panel-functionality.yml
Risk profile: docs/qa/assessments/17.2-risk-20260126.md
NFR assessment: docs/qa/assessments/17.2-nfr-20260126.md

### Recommended Status

[✓ Ready for Done]

## Status
Done
