# Story 5.3: Logging Migration

Status: review

## Story

As a developer,
I want all `print()` statements replaced with Python `logging` module calls,
so that log levels can be configured, output is structured, and debugging is easier in production.

## Acceptance Criteria

1. **Given** the codebase uses `print()` for output in `api.py`, `worker.py`, `pipeline.py` **When** I replace them with `logging.info()`, `logging.warning()`, `logging.error()` as appropriate **Then** no `print()` statements remain in `app/` source files (except `__main__` blocks)

2. **Given** the logging module is configured **When** the API or worker starts **Then** log output includes: timestamp, level, module name, and message **And** the log level is configurable via `LOG_LEVEL` environment variable (default: `INFO`)

3. **Given** a GPU OOM error occurs during generation **When** the worker handles the retry **Then** the error is logged at `ERROR` level with full traceback **And** retry attempts are logged at `WARNING` level

## Tasks / Subtasks

- [x] Task 1: Configure logging in config.py (AC: #2)
  - [x] 1.1 Add `LOG_LEVEL` environment variable to config.py (default: `INFO`)
  - [x] 1.2 Create `setup_logging()` function using `logging.basicConfig()` or `dictConfig`
  - [x] 1.3 Format: `%(asctime)s %(levelname)s %(name)s %(message)s`
  - [x] 1.4 Call `setup_logging()` at module import time in config.py
- [x] Task 2: Migrate pipeline.py (AC: #1) â€” 36 print() statements
  - [x] 2.1 Add `logger = logging.getLogger(__name__)` at module level
  - [x] 2.2 Replace all 36 print() calls with appropriate log level (see mapping below)
  - [x] 2.3 Ensure model loading details use `logger.info()`, errors use `logger.error()`
- [x] Task 3: Migrate model_manager.py (AC: #1) â€” 14 print() statements
  - [x] 3.1 Add `logger = logging.getLogger(__name__)` at module level
  - [x] 3.2 Replace all 14 print() calls with appropriate log level (see mapping below)
  - [x] 3.3 Download progress (`end='\r'` pattern on line 154) â€” replace with `logger.info()` at key milestones only (start, 25%, 50%, 75%, done)
- [x] Task 4: Migrate worker.py (AC: #1, #3) â€” 3 print() statements
  - [x] 4.1 Add `logger = logging.getLogger(__name__)` at module level
  - [x] 4.2 Replace 3 print() calls with appropriate log level
  - [x] 4.3 Ensure OOM retry uses `logger.error(exc_info=True)` for full traceback (AC #3)
  - [x] 4.4 Ensure retry attempts use `logger.warning()` (AC #3)
- [x] Task 5: Verify api.py (AC: #1)
  - [x] 5.1 Confirm api.py has zero print() statements (already clean from Sprint 1)
  - [x] 5.2 Add `logger = logging.getLogger(__name__)` for any future use
- [x] Task 6: Write tests (AC: #2, #3)
  - [x] 6.1 Test that LOG_LEVEL env var configures the root logger level
  - [x] 6.2 Test that log output includes timestamp, level, module name
  - [x] 6.3 Test that no print() statements remain in app/ source files (use grep/ast)

## Dev Notes

### Architecture Decision: INFRA-003

> **Decision**: Migrate from `print()` to Python `logging` module. Deferred to tech debt backlog â€” not blocking for MVP.
> **Target logging levels**:
>   - `DEBUG`: Model loading details, VRAM allocation, LoRA weight paths
>   - `INFO`: Request received, generation started/completed, model swap
>   - `WARNING`: Queue nearing capacity, VRAM > 80%, retry triggered
>   - `ERROR`: Generation failure, OOM, download failure
> **Format**: Structured JSON logs for Docker log aggregation compatibility
> **Implementation**: Single `logging.conf` or `dictConfig` in config.py. Replace `print()` statements progressively per module.
> [Source: _bmad-output/planning-artifacts/architecture.md#INFRA-003]

### Current print() Inventory (57 total)

| File | Count | Primary Use |
|------|-------|-------------|
| `app/pipeline.py` | 36 | Model loading, LoRA management, generation steps |
| `app/model_manager.py` | 14 | Civitai downloads, model/LoRA scanning |
| `app/worker.py` | 3 | Task errors, validation results |
| `app/api.py` | 0 | Already clean (Sprint 1 work) |
| `app/config.py` | 0 | Constants only |
| `app/models_config.py` | 0 | Pydantic models only |
| `app/references.py` | 0 | No print statements |

### Print-to-Log Level Mapping

**pipeline.py (36 statements):**

| Line | Current print() | Target Level | Rationale |
|------|----------------|-------------|-----------|
| 35 | `"ðŸš€ Initialisation du pipeline flexible..."` | `INFO` | Startup event |
| 49 | `"âœ… Pipeline prÃªt sur {self.device}"` | `INFO` | Startup complete |
| 55 | `"â„¹ï¸  ModÃ¨le {model_id} dÃ©jÃ  chargÃ©"` | `DEBUG` | Model cache hit â€” verbose |
| 58 | `"ðŸ”„ Chargement du modÃ¨le: {model_id}"` | `INFO` | Model swap event |
| 62 | `"ðŸ§¹ Nettoyage du modÃ¨le prÃ©cÃ©dent..."` | `DEBUG` | Internal cleanup detail |
| 74 | `"â¬‡ï¸  Chargement de {model_config.full_name}..."` | `INFO` | Model loading |
| 79 | `"ðŸ“¦ Chargement depuis checkpoint..."` | `DEBUG` | Loading detail |
| 85 | `"â¬‡ï¸  TÃ©lÃ©chargement du checkpoint..."` | `INFO` | Download event |
| 93 | `"âœ… Checkpoint tÃ©lÃ©chargÃ©: {checkpoint_path}"` | `INFO` | Download complete |
| 107 | `"ðŸ“¦ Chargement depuis pipeline diffusers..."` | `DEBUG` | Loading detail |
| 119 | `"ðŸ”‘ Utilisation du token HuggingFace"` | `DEBUG` | Auth detail |
| 128 | `"â¬‡ï¸  Chargement VAE: {model_config.vae_path}"` | `DEBUG` | Loading detail |
| 147 | `"âš¡ Configuration Compel..."` | `DEBUG` | Setup detail |
| 156 | `"âš™ï¸  Activation des optimisations GPU..."` | `DEBUG` | Optimization detail |
| 164 | `"âœ… ModÃ¨le {model_id} prÃªt"` | `INFO` | Model ready event |
| 171 | `"ðŸ§¹ DÃ©chargement des LoRAs..."` | `DEBUG` | Cleanup detail |
| 187 | `"âš ï¸  LoRA {lora_id} non trouvÃ©, ignorÃ©"` | `WARNING` | Missing resource |
| 192 | `"â¬‡ï¸  Chargement LoRA: {lora_config.name}..."` | `INFO` | LoRA loading |
| 210 | `"âŒ Erreur chargement LoRA {lora_id}: {e}"` | `ERROR` | LoRA load failure |
| 219 | `"âœ… LoRAs actifs: {', '.join(adapter_names)}"` | `INFO` | LoRA activation |
| 221 | `"âš ï¸  Aucun LoRA chargÃ©"` | `WARNING` | No LoRA loaded |
| 236 | `"ðŸ’¡ Prompt enrichi avec trigger words"` | `DEBUG` | Enhancement detail |
| 243 | `"â¬‡ï¸  Chargement IP-Adapter..."` | `INFO` | IP-Adapter loading |
| 251 | `"âœ… IP-Adapter charge"` | `INFO` | IP-Adapter ready |
| 307 | `"ðŸ“ Prompt ({len(enhanced_prompt)} chars)"` | `DEBUG` | Prompt detail |
| 334 | `"ðŸŽ­ IP-Adapter: {len(raw_images)} reference(s)..."` | `INFO` | Generation config |
| 343 | `"ðŸŽ­ IP-Adapter legacy (strength={ip_strength})"` | `INFO` | Generation config |
| 349 | `"ðŸŽ² Seed: {seed}"` | `DEBUG` | Generation detail |
| 351 | `"ðŸŽ¨ GÃ©nÃ©ration (steps={steps}, cfg={guidance_scale})..."` | `INFO` | Generation start |
| 368 | `"âœ… GÃ©nÃ©ration terminÃ©e"` | `INFO` | Generation complete |
| 372 | `"âŒ Erreur: {e}"` | `ERROR` | Generation failure â€” use `exc_info=True` |

**model_manager.py (14 statements):**

| Line | Current print() | Target Level |
|------|----------------|-------------|
| 55 | `"âš ï¸  Erreur vÃ©rification modÃ¨le..."` | `WARNING` |
| 102 | `"ðŸ“¥ RÃ©cupÃ©ration infos Civitai..."` | `INFO` |
| 110 | `"âŒ Aucune version disponible"` | `ERROR` |
| 126 | `"âŒ Aucun fichier tÃ©lÃ©chargeable trouvÃ©"` | `ERROR` |
| 134 | `"â¬‡ï¸  TÃ©lÃ©chargement depuis Civitai..."` | `INFO` |
| 135 | `"    URL: {download_url}"` | `DEBUG` |
| 154 | `"    Progression: {progress:.1f}%"` (with `end='\r'`) | `INFO` at milestones only |
| 156 | `"âœ… TÃ©lÃ©chargÃ©: {output_path}"` | `INFO` |
| 160 | `"âŒ Erreur tÃ©lÃ©chargement Civitai..."` | `ERROR` â€” use `exc_info=True` |
| 190 | `"âš ï¸  Erreur listage modÃ¨les..."` | `WARNING` |
| 236 | `"âš ï¸  Erreur scan LoRAs HuggingFace..."` | `WARNING` |

**worker.py (3 statements):**

| Line | Current print() | Target Level |
|------|----------------|-------------|
| 141 | `"âŒ Erreur task: {exc}"` | `ERROR` â€” use `exc_info=True` (AC #3) |
| 161 | `"âœ… Reference validee..."` | `INFO` |
| 170 | `"âŒ Erreur validation..."` | `ERROR` â€” use `exc_info=True` |

### Implementation Pattern

```python
# In app/config.py â€” add at the end:
import logging
import os

LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()

def setup_logging():
    logging.basicConfig(
        level=getattr(logging, LOG_LEVEL, logging.INFO),
        format="%(asctime)s %(levelname)s %(name)s %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S",
    )

setup_logging()
```

```python
# In each app module (pipeline.py, worker.py, model_manager.py):
import logging

logger = logging.getLogger(__name__)

# Replace: print(f"ðŸš€ Initialisation du pipeline flexible...")
# With:    logger.info("Initialisation du pipeline flexible")

# Replace: print(f"âŒ Erreur: {e}")
# With:    logger.error("Generation failed", exc_info=True)
```

### Emoji Handling

**Remove all emojis** from log messages. The emoji convention (`ðŸš€`, `âœ…`, `âŒ`, etc.) was useful for terminal `print()` output but is noise in structured logs. The log level (INFO, ERROR, WARNING) already conveys the same semantic meaning.

### Download Progress Pattern

The `print(f"    Progression: {progress:.1f}%", end='\r')` pattern in `model_manager.py:154` uses carriage return for in-place terminal updates. This doesn't work with `logging`. Replace with milestone logging:

```python
# Instead of progress bar, log at key milestones
for chunk in response.iter_content(chunk_size=8192):
    # ... download logic ...
    if progress >= next_milestone:
        logger.info("Download progress: %.0f%%", progress)
        next_milestone += 25  # Log at 25%, 50%, 75%, 100%
```

### Dependency on Story 5.2

Celery 5.6.2 (from Story 5.2) no longer logs broker credentials by default (SEC-004 fix). The logging migration should NOT change any Celery logging configuration â€” only replace `print()` in our code.

### Anti-Patterns to Avoid

1. **DO NOT** use `logging.setLevel()` on individual loggers â€” configure at root level only via `setup_logging()`
2. **DO NOT** keep emojis in log messages â€” they add noise in structured/JSON log output
3. **DO NOT** change any business logic â€” only replace `print()` with appropriate `logger.X()` calls
4. **DO NOT** add logging to `__init__.py` or `__main__` blocks
5. **DO NOT** configure Celery's internal logging â€” only our application code
6. **DO NOT** use `logger.exception()` outside of exception handlers â€” use `logger.error(msg, exc_info=True)` instead
7. **DO NOT** log sensitive data (API keys, file paths with secrets)

### Testing Guidance

```python
# Test LOG_LEVEL env var
def test_log_level_from_env(monkeypatch):
    monkeypatch.setenv("LOG_LEVEL", "DEBUG")
    # Re-import or call setup_logging()
    # Assert root logger level == DEBUG

# Test no print() in app/ source
def test_no_print_statements():
    import ast, pathlib
    app_dir = pathlib.Path("app")
    for py_file in app_dir.glob("*.py"):
        tree = ast.parse(py_file.read_text())
        for node in ast.walk(tree):
            if isinstance(node, ast.Call):
                func = node.func
                if isinstance(func, ast.Name) and func.id == "print":
                    # Allow in __main__ blocks
                    assert False, f"print() found in {py_file}:{node.lineno}"
```

### References

- [Source: _bmad-output/planning-artifacts/architecture.md#INFRA-003]
- [Source: _bmad-output/planning-artifacts/epics.md#Story-5.3]
- [Source: app/pipeline.py] (36 print statements)
- [Source: app/model_manager.py] (14 print statements)
- [Source: app/worker.py] (3 print statements)
- [Source: app/config.py] (logging setup target)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- **DEVIATION**: Dockerfile fix (out of scope) â€” `pip3` pointed to Python 3.10 but lockfile requires >=3.11 (`networkx==3.6.1`). Fixed by setting `python3.11` as default via `update-alternatives` and bootstrapping pip with `get-pip.py`. Discovered during Docker smoke test. Pre-existing tech debt, not related to logging migration.

### Completion Notes List

- Replaced 53 print() statements across 4 files with structured logging (logging module)
- Added `setup_logging()` in config.py with LOG_LEVEL env var (default: INFO), format: `%(asctime)s %(levelname)s %(name)s %(message)s`
- All emojis removed from log messages per Dev Notes guidance
- OOM errors: `logger.error(exc_info=True)` for full traceback (AC #3)
- Retry attempts: `logger.warning()` with attempt count (AC #3)
- Download progress: milestone logging at 25% intervals instead of `\r` carriage return
- Docker smoke test confirmed structured logs work in production: `2026-02-07 14:07:24 INFO app.pipeline Modele sdxl pret`
- 56 tests passing (9 new for story 5.3, 47 existing â€” 0 regressions)

### Code Review Fixes

- **[HIGH] AC #3 test coverage**: Added 2 tests for OOM logging (ERROR+traceback) and retry warning (WARNING+attempt count). AC #3 now fully tested.
- **[MEDIUM] Retry count format**: Fixed `worker.py:146` â€” denominator changed from `self.max_retries` to `self.max_retries + 1` to show correct total attempts (e.g., "tentative 1/4" instead of "tentative 1/3" with max_retries=3).
- **[MEDIUM] INFRA-003 gap noted**: Architecture decision INFRA-003 specifies "Structured JSON logs" but AC #2 and Implementation Pattern prescribe plain text. Plain text satisfies AC #2. JSON format deferred â€” can be addressed in a future story if Docker log aggregation is needed.
- **[LOW] Not fixed**: Log message language mix (FR/EN), api.py unused logger, test `_fmt` access â€” deferred as non-blocking.

### Change Log

- 2026-02-07: Story 5.3 implementation complete â€” logging migration (53 printâ†’logger)
- 2026-02-07: DEVIATION â€” Dockerfile fixed for Python 3.11 compatibility (pre-existing tech debt)
- 2026-02-07: Code review fixes â€” AC #3 tests added, retry count fixed, INFRA-003 gap documented

### File List

- `app/config.py` â€” Added LOG_LEVEL, setup_logging()
- `app/pipeline.py` â€” 36 print() â†’ logger (INFO/DEBUG/WARNING/ERROR)
- `app/model_manager.py` â€” 14 print() â†’ logger, milestone download progress
- `app/worker.py` â€” 3 print() â†’ logger, OOM exc_info + retry warning, retry count fix
- `app/api.py` â€” Added logger import (0 print changes, already clean)
- `tests/test_story_5_3_logging_migration.py` â€” 9 tests (AC #1, #2, #3)
- `dockerfile` â€” DEVIATION: Python 3.11 default + get-pip.py bootstrap
