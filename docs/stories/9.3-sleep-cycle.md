# Story 9.3: The Sleep Cycle (Cognitive Consolidation)

**Status:** Done
**Epic:** 9 - Cognitive Consolidation

## Story
**As a** Platform Owner,
**I want** a background process that periodically analyzes recent conversation history to extract atomic facts and user preferences,
**so that** agents can build a long-term "Subjective Memory" (MDP) and provide more personalized interactions.

## Acceptance Criteria
1. [x] A new service `MemoryConsolidator` is implemented in `apps/h-core/src/domain/memory.py`.
2. [x] A manual trigger is available via `POST /api/memory/consolidate` for debugging and immediate updates.
3. [x] The process retrieves all messages from SurrealDB that haven't been processed yet (tracked via a `processed` flag).
4. [x] An LLM call (via LiteLLM) is used to extract a list of "Atomic Facts" (e.g., "User likes tea", "User is tired") from the conversation chunk.
5. [x] Extracted facts are stored in a new SurrealDB collection `memories` with metadata (agent_id, source_ids, confidence).
6. [x] Messages processed are updated in SurrealDB with `processed: true`.
7. [x] A `SYSTEM_LOG` (Info) is broadcasted summarizing the consolidation results (e.g., "Sleep Cycle complete: 5 new facts learned").

## Tasks / Subtasks
- [x] Backend: Infrastructure (AC: #1, #2)
    - [x] Create `memory.py` and the `MemoryConsolidator` class.
    - [x] Add the FastAPI route to `main.py`.
- [x] Backend: Data Flow (AC: #3, #6)
    - [x] Implement `get_unprocessed_messages()` in `SurrealDbClient`.
    - [x] Implement `mark_as_processed(message_ids)` in `SurrealDbClient`.
- [x] Backend: Intelligence (AC: #4, #5)
    - [x] Design the "Memory Extraction" system prompt.
    - [x] Implement `consolidate_session()` using LiteLLM to generate the facts.
    - [x] Store facts in the `memories` table (with embeddings for future RAG).
- [x] Integration: Monitoring (AC: #7)
    - [x] Broadcast system logs during the cycle.

## Dev Notes
- **Fact Format**: `{ "fact": "...", "subject": "user", "agent": "Renarde", "confidence": 0.85 }`.
- **Batching**: Process in batches of 20 messages to keep context window clean.
- **Tech Stack**: Uses LiteLLM for extraction and SurrealDB for storage. [Source: architecture/3-tech-stack.md]
- **Data Model**: MDP concepts from [Source: architecture/4-modles-de-donnes-mmoire-subjective.md].

## Testing
- **Framework**: `pytest`
- **Focus**: Verify that facts extracted correctly match the input conversation (via mocks).
- **Integration**: Verify that the `processed` flag is correctly set in SurrealDB.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Initial draft for Sleep Cycle | Bob (SM) |
| 2026-01-23 | 1.1 | Implementation completed and unit tested | James (Dev) |

## Dev Agent Record
- **Agent Model Used**: Gemini 2.0 Flash
- **Debug Log References**: [N/A]
- **Completion Notes List**:
    - [Implemented MemoryConsolidator service for atomic fact extraction]
    - [Added get_unprocessed_messages and mark_as_processed to SurrealDbClient]
    - [Created POST /api/memory/consolidate manual trigger]
    - [Verified logic with unit tests]
- **File List**:
    - `apps/h-core/src/domain/memory.py`
    - `apps/h-core/src/infrastructure/surrealdb.py`
    - `apps/h-core/src/main.py`
    - `apps/h-core/tests/test_memory.py`

## QA Results



### Review Date: 2026-01-23



### Reviewed By: Quinn (Test Architect)



### Code Quality Assessment

Solid implementation of the first "Sleep Cycle" mechanism. The developer appropriately handled JSON cleaning from the LLM and ensured that message processing is state-tracked. The injection of infrastructure into the domain service is correct and follows project patterns.



### Refactoring Performed

- **File**: `apps/h-core/src/domain/memory.py`

  - **Change**: Added JSON block cleaning (markdown stripping).

  - **Why**: LLMs often wrap JSON output in backticks, causing `json.loads` to fail.



### Compliance Check

- Coding Standards: [✓]

- Project Structure: [✓]

- Testing Strategy: [✓] (Logic verified via AsyncMock suite)

- All ACs Met: [✓]



### Improvements Checklist

- [x] Implemented MemoryConsolidator service

- [x] Added processed flag tracking in SurrealDB

- [x] Configured atomic fact extraction prompt

- [x] Integrated manual trigger endpoint

- [ ] Implement an automatic scheduler for the Sleep Cycle (V3.1)



### Gate Status

Gate: PASS → docs/qa/gates/9.3-sleep-cycle.yml

Risk profile: docs/qa/assessments/9.3-risk-20260123.md

NFR assessment: docs/qa/assessments/9.3-nfr-20260123.md

Trace matrix: docs/qa/assessments/9.3-trace-20260123.md



### Recommended Status

[✓ Ready for Done]
