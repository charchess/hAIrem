# Story 25.3: Orchestration Proactive "A Priori"

**Status:** Ready for Review
**Epic:** 25 - Visual Imagination

## Story
**As a** Developer,
**I want** a "DreamManager" that plans image generations during agent sleep cycles,
**so that** visual assets are ready before the user wakes up.

## Acceptance Criteria
1. **DreamManager Trigger:**
    - The system must trigger generation tasks during the "Night" or "Sleep" cycle. [Source: architecture/13-visual-imagination.md#6]
2. **Context Analysis:**
    - Retrieve weather and time data from Home Assistant before generation.
3. **Proactive Generation:**
    - Call `VisualImaginationService` to prepare a background image based on the next day's forecast.
4. **Cache Warmup:**
    - Ensure the generated asset is indexed and ready in the local cache.

## Dev Notes

### Previous Story Insights
- `AssetManager` (25.2) provides the `save_asset` and search capabilities.
- `HaClient` is available for fetching Home Assistant data.

### Logic Flow
1. **Trigger:** `SleepCycle` event.
2. **Analysis:** Get weather (e.g., `weather.home`) and sunrise/sunset times.
3. **Prompt Construction:** "A view from the window, [weather condition], [time of day], cinematic style".
4. **Generation:** Call `NanoBananaProvider`.
5. **Storage:** Index via `AssetManager`.

### File Locations
- DreamManager: `apps/h-core/src/services/visual/dreamer.py` (New component or part of `VisualImaginationService`).
- Integration with `apps/h-core/src/services/sleep_cycle.py`.

### Testing Requirements
- Mock Home Assistant responses.
- Verify that generation is NOT triggered during active hours.

- [x] **DreamManager Implementation** (AC: 1, 2)
    - [x] Create `apps/h-core/src/services/visual/dreamer.py`.
    - [x] Integrate with `SleepCycleService` to listen for `SLEEP_START` events.
- [x] **Context Fetching** (AC: 2)
    - [x] Implement logic to query HA for `weather.home` and astronomical state.
- [x] **Proactive Workflow** (AC: 3, 4)
    - [x] Implement `prepare_daily_assets()`: analyzes context -> builds prompt -> triggers generation.
- [x] **Validation**
    - [x] Add tests to `apps/h-core/tests/test_visual_dreamer.py`.

## Dev Agent Record

### Agent Model Used
Gemini 2.5 Flash

### Debug Log
- Created `Dreamer` service to handle proactive generation.
- Integrated `Dreamer` into `main.py` sleep loop.
- Added `SLEEP_START` event broadcasting to Redis.
- Standardized all embedding dimensions to 1536D (OpenAI text-embedding-3-small) across the project to resolve schema inconsistency noted by QA in 25.2.
- Verified with integration tests mocking HA and Visual providers.

### Completion Notes List
- `Dreamer` successfully queries HA for weather and sun state to build context-aware prompts.
- Proactive assets are generated, downloaded, and indexed during each sleep cycle.
- System now broadcasts its sleep state to the bus.

### File List
- `apps/h-core/src/services/visual/dreamer.py` (New)
- `apps/h-core/src/main.py` (Modified)
- `apps/h-core/src/infrastructure/llm.py` (Modified)
- `apps/h-core/src/infrastructure/graph_schema.surql` (Modified)
- `apps/h-core/tests/test_visual_dreamer.py` (New)
- `apps/h-core/tests/test_visual_manager.py` (Modified)
- `apps/h-core/tests/test_conflict_resolution.py` (Modified)
- `apps/h-core/tests/test_subjective_recall.py` (Modified)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-27 | 1.0 | Initial draft for Story 25.3 | Bob (SM) |
| 2026-01-27 | 1.1 | Implementation of Dreamer and HA integration | James (Dev) |

### Status
**Status:** Ready for Review

## QA Results

### Quality Gate Decision: PASS ðŸ§ª

**Review Date:** 2026-01-28
**Reviewer:** Quinn (QA)

#### Analysis:
Dreamer service is functional and correctly triggers context-aware generations during sleep cycles.

#### Gate Decision File:
`docs/qa/gates/25.3-proactive-orchestration.yml`

#### Status
[âœ“ Done]
