# Story 9.2: Privacy Filter Middleware

**Status:** Done
**Epic:** 9 - Cognitive Consolidation

## Story
**As a** User / Privacy-conscious Owner,
**I want** sensitive information (API keys, passwords, specific PII) to be redacted using both pattern matching and context analysis,
**so that** my private credentials and data are not exposed to external LLM providers or indexed in the permanent vector store.

## Acceptance Criteria
1. [ ] A new `PrivacyFilter` utility is implemented in `apps/h-core/src/utils/privacy.py`.
2. [ ] **Multi-layer Detection Logic**:
    - **Layer 1 (Regex)**: Standard patterns for API Keys (`AIza`, `sk-`, etc.), IP Addresses, and explicit tokens.
    - **Layer 2 (Context)**: Redaction of strings following trigger keywords (e.g., "password:", "mdp =", "secret:").
    - **Layer 3 (High Entropy)**: Identification and redaction of non-natural language strings with high character complexity.
3. [ ] The filter is applied in `main.py` *before* any background task for SurrealDB persistence or embedding generation.
4. [ ] A `SYSTEM_LOG` (Warning) is broadcasted whenever a redaction occurs.
5. [ ] Unit tests verify successful redaction of both formatted (API keys) and unformatted (passwords in context) secrets.

## Tasks / Subtasks
- [ ] Backend: Implement `PrivacyFilter` (AC: #1, #2)
    - [ ] Create `privacy.py`.
    - [ ] Implement regex patterns for common AI API keys.
    - [ ] Implement contextual look-ahead/look-behind for "password"-like keywords.
    - [ ] Add a basic Shannon entropy check for suspicious strings.
- [ ] Backend: Integration (AC: #3, #4)
    - [ ] Update `main.py` to pass all text through `PrivacyFilter.redact()` before persistence.
    - [ ] Log redaction events to the system bus.
- [ ] Testing: Security Validation (AC: #5)
    - [ ] Create `apps/h-core/tests/test_privacy.py`.
    - [ ] Test cases: "My password is 'hunter2'", "API Key: AIzaSy...", "Connect to 192.168.1.1".

## Dev Notes
- **Entropy Threshold**: A common threshold for secrets is ~3.5 to 4.5 bits depending on length.
- **Redaction String**: Use `[REDACTED]` as the replacement.
- **Performance**: Ensure the filter is efficient as it runs on every message.
- **Source Tree**: Utility located in `apps/h-core/src/utils/`.

## Testing
- **Test file location**: `apps/h-core/tests/test_privacy.py`
- **Framework**: `pytest`
- **Focus**: False positive vs False negative balance.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Initial draft with enhanced security | Bob (SM) |

## Dev Agent Record
- **Agent Model Used**: [Pending]
- **Debug Log References**: [Pending]
- **Completion Notes List**: [Pending]
- **File List**: [Pending]

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
High-quality implementation of a critical security feature. The triple-layer detection (Regex, Context, Entropy) provides a solid balance between catching known patterns and identifying unknown secrets. The integration in `main.py` is appropriately placed to protect cold storage and external vector providers.

### Refactoring Performed
- **File**: `apps/h-core/src/main.py`
  - **Change**: Integrated `PrivacyFilter` into background persistence tasks.
  - **Why**: To ensure redaction happens before any long-term storage or embedding.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Unit tests verify all detection layers)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Implemented PrivacyFilter utility
- [x] Integrated Multi-layer detection logic
- [x] Applied filter before persistence and embeddings
- [x] Verified redaction via unit tests
- [ ] Monitor false positive rates for technical discussions

### Gate Status
Gate: PASS → docs/qa/gates/9.2-privacy-filter.yml
Risk profile: docs/qa/assessments/9.2-risk-20260123.md
NFR assessment: docs/qa/assessments/9.2-nfr-20260123.md
Trace matrix: docs/qa/assessments/9.2-trace-20260123.md

### Recommended Status
[✓ Ready for Done]
