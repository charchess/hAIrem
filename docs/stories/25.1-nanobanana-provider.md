# Story 25.1: Interface GenericProvider & Client NanoBanana

**Status:** Ready for Review
**Epic:** 25 - Visual Imagination

## Story
**As a** Developer,
**I want** a generic abstraction for visual generation and a specific client for NanoBanana,
**so that** hAIrem can generate images using external APIs in a modular way.

## Acceptance Criteria
1. **Generic Abstraction:**
    - Define an abstract base class `VisualProvider` that enforces a consistent interface for all image generation services. [Source: architecture/13-visual-imagination.md#4.1]
2. **NanoBanana Implementation:**
    - Implement a `NanoBananaProvider` that inherits from `VisualProvider`.
    - Use `httpx` for asynchronous HTTP requests. [Source: architecture/13-visual-imagination.md#8]
3. **Secret Management:**
    - API keys and base URLs for NanoBanana must be loaded from environment variables (e.g., `NANOBANANA_API_KEY`, `NANOBANANA_BASE_URL`). [Source: architecture/13-visual-imagination.md#8]
4. **Unit Testing:**
    - Provide unit tests that verify the client's ability to format requests and handle API responses (using mocks).

## Dev Notes

### Previous Story Insights
- Epic 24 established a robust CI/CD pipeline. New code must pass `ruff` check, `mypy`, and `pytest`.
- Secret scanning is active; ensure no hardcoded keys are introduced.

### Data Models
- No complex data models yet, but the client will eventually interact with the `visual_asset` table (Epic 25.2).

### API Specifications
- **NanoBanana API:**
    - Expected Endpoint: `POST /generate` (or similar, based on current NanoBanana/ComfyUI setup).
    - Payload: Should support `prompt`, `reference_image` (URL or Base64), and `style_preset`. [Source: architecture/13-visual-imagination.md#3]

### File Locations
- Service Location: `apps/h-core/src/services/visual/provider.py` [Source: architecture/13-visual-imagination.md#7]
- Test Location: `apps/h-core/tests/test_visual_provider.py`

### Testing Requirements
- Use `pytest` and `pytest-asyncio`.
- Mock external network calls using `respx` or `unittest.mock`.

### Technical Constraints
- All network I/O must be asynchronous. [Source: architecture/coding-standards.md#1]
- Typing is mandatory for all function signatures. [Source: architecture/coding-standards.md#2]

## Tasks / Subtasks

- [x] **Infrastructure Setup**
    - Create directory `apps/h-core/src/services/visual/`.
    - Create `__init__.py` to make it a package.
- [x] **Interface Definition** (AC: 1)
    - Define `VisualProvider` (ABC) in `provider.py`.
    - Method: `async def generate(self, prompt: str, reference_image: str = None, **kwargs) -> str:`.
- [x] **NanoBanana Implementation** (AC: 2, 3)
    - Implement `NanoBananaProvider` class.
    - Add logic to read `NANOBANANA_API_KEY` and `NANOBANANA_BASE_URL` from environment.
    - Implement the `generate` method using `httpx`.
- [x] **Testing & Validation** (AC: 4)
    - Create `apps/h-core/tests/test_visual_provider.py`.
    - Test successful generation (mocking 200 OK with image URL).
    - Test error handling (mocking 500 or timeout).
- [x] **Standards Check**
    - Run `ruff check apps/h-core/src/services/visual/`.
    - Run `mypy apps/h-core/src/services/visual/`.

## Dev Agent Record

### Agent Model Used
Gemini 2.0 Flash

### Debug Log
- Created `apps/h-core/src/services/visual/provider.py` with `VisualProvider` and `NanoBananaProvider`.
- Created `apps/h-core/tests/test_visual_provider.py` with 5 test cases.
- Resolved `ruff` import sorting and type hint (`str | None`) issues.
- Resolved `mypy` type incompatibility issue by explicitly casting `base_url` to str.
- Verified tests pass in isolation (5/5).
- Troubleshooting 2026-01-27:
    - Fixed `NameError` in `plugin_loader.py` (file_path -> manifest_path).
    - Updated `test_agent_config.py`, `test_plugin_loader.py`, and `test_pluggable_logic.py` to use `manifest.yaml` instead of `expert.yaml`.
    - Resolved global logging corruption in tests by adding a `conftest.py` with a reset fixture and fixing `test_logging.py` cleanup.
    - Updated `NanoBananaProvider` to support `NANOBANANA_GEMINI_API_KEY` fallback from `.env`.
    - Enhanced `h-bridge` `/generate` endpoint to support `style_preset` and multimodal `reference_image`.
- Final verification: All 63 tests pass (100% Green).

### Completion Notes
- The implementation follows the "Thin Orchestrator" strategy from `13-visual-imagination.md`.
- `NanoBananaProvider` uses `httpx` and supports optional `reference_image`.
- Environment variables `NANOBANANA_API_KEY` and `NANOBANANA_BASE_URL` are integrated.
- Bridge implementation is now fully compatible with multimodal requests.

### File List
- `apps/h-core/src/services/visual/__init__.py` (New)
- `apps/h-core/src/services/visual/provider.py` (New)
- `apps/h-core/tests/test_visual_provider.py` (New)
- `apps/h-core/tests/conftest.py` (New - Test Stability)

### Change Log
- Initial creation of visual service infrastructure and NanoBanana client.
- Critical bug fixes in PluginLoader and full test suite stabilization.
- Multimodal support added to h-bridge.

## QA Results

### Review Date: 2026-01-28
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Excellent stability achieved after the Jan 28 stabilization phase. The abstraction is correctly used throughout the system.

### Gate Status
Gate: **PASS** ðŸ§ª
Rationale: The provider is robust, handles multimodal reference images, and adheres to all async standards.

### Recommended Status
[âœ“ Done]