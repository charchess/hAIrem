# Story 5.9: Core Infrastructure for AAA (Task Nursery & Lifecycle)

## Status
- **Status:** Done
- **Priority:** P0

## Story
**As a** Core Developer,
**I want** to provide a "Task Nursery" and a lifecycle management system to the agents,
**so that** they can safely run background tasks (like device monitoring) and clean up resources when stopped.

## Acceptance Criteria
1. **Task Nursery:** Add a `spawn_task(coroutine)` method to `BaseAgent`.
2. **Task Tracking:** The `BaseAgent` must keep track of all tasks spawned by the agent.
3. **Graceful Shutdown:** Implement a `stop()` method in `BaseAgent` that cancels all tracked tasks and calls an optional `teardown()` hook.
4. **Core Integration:** The `PluginLoader` must call `agent.stop()` when an agent is being reloaded or when the system shuts down.
5. **Robustness:** If a spawned task crashes, it should be logged without bringing down the entire H-Core process.

## Tasks / Subtasks
- [x] Update `apps/h-core/src/domain/agent.py`
    - [x] Add `self._tasks: List[asyncio.Task]` to `BaseAgent`.
    - [x] Implement `spawn_task(coro)`.
    - [x] Implement `stop()` and `teardown()`.
- [x] Update `apps/h-core/src/infrastructure/plugin_loader.py`
    - [x] Ensure `stop()` is called before replacing an agent instance during hot-reload.
- [x] Verification
    - [x] Create a test agent that spawns a task and verify it is cancelled when the agent is stopped.

## Dev Agent Record
### Agent Model Used
- Gemini 2.0 Flash (via hAIrem Framework)

### Debug Log
- 2026-01-25 19:15: Implemented `spawn_task` with crash-wrapping in `BaseAgent`.
- 2026-01-25 19:20: Added `stop()` method with support for async/sync `teardown()` hooks.
- 2026-01-25 19:25: Updated `PluginLoader` to call `stop()` on old agents during hot-reload.
- 2026-01-25 19:30: Validated with `tests/validate_5_9.py`.

### Completion Notes
- The Task Nursery pattern is now standard for all agents.
- Agents can safely run background loops (like WebSockets) without fear of task leaks.
- Shutdown is now graceful and tracked.

### File List
- `apps/h-core/src/domain/agent.py` (Modified)
- `apps/h-core/src/infrastructure/plugin_loader.py` (Modified)
- `apps/h-core/src/main.py` (Modified)
- `agents/electra/logic.py` (Modified)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-24 | 1.0 | Initial Draft | Bob (SM) |
| 2026-01-25 | 1.1 | Formalized Task Nursery and Lifecycle | James (Dev) |

## QA Results

### Review Date: 2026-01-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

L'implémentation du pattern "Nursery" est excellente. Elle apporte une rigueur indispensable à la gestion asynchrone des agents. La séparation entre `spawn_task` (exécution), `stop` (orchestration) et `teardown` (nettoyage spécifique) est exemplaire.

### Refactoring Performed

- **Auto-Cleanup** : J'ai ajouté un `done_callback` dans `spawn_task` pour supprimer automatiquement les tâches terminées de la liste `_tasks`, évitant ainsi toute fuite de mémoire sur des tâches à durée de vie courte.
- **Robustesse du Stop** : La méthode `stop()` a été renforcée par un `asyncio.gather(*self._tasks, return_exceptions=True)` pour garantir que le framework attend bien la fin effective de toutes les tâches annulées avant de libérer l'instance.

### Compliance Check

- Coding Standards: [✓] Isolation et asynchronicité parfaites.
- Project Structure: [✓] Amélioration du socle `BaseAgent`.
- Testing Strategy: [✓] Validation unitaire réussie.
- All ACs Met: [✓] Système de cycle de vie complet.

### Gate Status

Gate: PASS → docs/qa/gates/5.9-core-nursery-lifecycle.yml

### Recommended Status

[✓ Ready for Done]