# Story 5.5: Expert-Domotique Home Assistant Integration

## Status
- **Status:** Obsolete (Merged into 5.6)
- **Priority:** P0

## Story
**As a** User,
**I want** my "Expert-Domotique" agent to actually control my home,
**so that** I can ask it to check sensors or toggle devices via natural language.

## Acceptance Criteria
1. **Custom Logic Implementation:** Create `agents/expert-domotique/logic.py`.
2. **HA Client Integration:** The `ExpertAgent` class must instantiate and use `src.infrastructure.home_assistant.HaClient`.
3. **Exposed Tools:** Implement at least two tools:
    - `get_entity_state(entity_id: str)`: Returns the current state of a Home Assistant entity.
    - `call_ha_service(domain: str, service: str, service_data: dict)`: Calls a service on Home Assistant.
4. **Natural Language Loop:** The LLM must be able to use these tools during a narrative conversation (e.g., "Quelle est la température du salon ?").
5. **Feedback:** The agent must confirm the action or report the state in its narrative response.

## Tasks / Subtasks
- [x] Create `agents/expert_domotique/logic.py`
    - [x] Define `class Agent(BaseAgent)`.
    - [x] Initialize `HaClient`.
- [x] Define `@tool` methods
    - [x] Implement `get_state` wrapper. (Implemented as `get_entity_state`)
    - [x] Implement `call_service` wrapper. (Implemented as `call_ha_service`)
- [x] Configuration
    - [x] Ensure `HA_URL` and `HA_TOKEN` are correctly passed through environment variables.
- [x] Verification
    - [x] Mock HA API response and verify the Expert agent correctly reports it in chat.

## Dev Notes
- This story depends on **5.4** being completed.
- Renamed folder `agents/expert-domotique` to `agents/expert_domotique` to avoid Python import issues in tests.
- `logic.py` successfully exposes HA tools to the LLM.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-24 | 1.0 | Initial Draft | Bob (SM) |
| 2026-01-24 | 1.1 | Implemented HA logic and tools for Expert agent | James (Dev) |

## Dev Agent Record
### Agent Model Used
gemini-2.0-flash-exp

### Debug Log References
- `apps/h-core/tests/test_expert_ha_logic.py` passed.

### Completion Notes List
- Expert-Domotique now has real "hands" via `logic.py`.
- Two tools registered: `get_entity_state` and `call_ha_service`.
- Folder renamed to `expert_domotique` for consistency.

### File List
- `agents/expert_domotique/logic.py`
- `apps/h-core/tests/test_expert_ha_logic.py`

## Status
Ready for Review

## QA Results

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation of the Expert-Domotique logic is a major milestone for the project. By utilizing the `logic.py` sidecar pattern, the developer has successfully decoupled the complex Home Assistant integration from the generic `BaseAgent`. The tools are cleanly defined and leverage the existing `HaClient` infrastructure efficiently.

The inclusion of unit tests that mock the Home Assistant API ensures that the logic is verified without requiring a live HA instance during the build process.

### Refactoring Performed
None. The code follows the newly established architectural patterns perfectly.

### Compliance Check
- Coding Standards: [✓] (Async/Await, decorators, type hints)
- Project Structure: [✓] (Correct use of agents/expert_domotique/logic.py)
- Testing Strategy: [✓] (Unit tests cover tool execution and loading)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Implement HA logic in logic.py
- [x] Register entity_state tool
- [x] Register call_service tool
- [x] Verify LLM loop support
- [ ] Add explicit validation for `service_data` dictionary keys in `call_ha_service`.

### Security Review
- **Authentication**: HA Token is correctly managed via environment variables.
- **Exposure**: Only specifically registered `@tool` methods are accessible to the LLM, maintaining a strict security perimeter.

### Performance Considerations
- **Non-blocking**: All HA calls are asynchronous, ensuring the agent fleet remains responsive even if Home Assistant is slow.

### Gate Status
Gate: PASS → docs/qa/gates/5.5-expert-ha-logic.yml

### Recommended Status
[✓ Ready for Done]