# Story 25.7: Vault System (Named Inventory & Asset Locking)

**Status:** Ready for Review
**Epic:** 25 - Visual Imagination

## Story
**As an** Agent,
**I want** to give names to my favorite visual assets (outfits, backgrounds),
**so that** I can reuse them exactly as they were without relying on approximate semantic search.

## Acceptance Criteria
1. **Vault Schema Implementation:**
    - Define a `vault` table in SurrealDB.
    - Fields: `name` (string), `agent_id` (record<subject>), `asset_id` (record<visual_asset>), `category` ("garment" | "background").
    - Unique index on `(agent_id, name)`.
2. **Named Persistence Logic:**
    - Implement `VaultService.save_item(agent_id, name, asset_id, category)`.
    - If the name already exists for that agent, it updates the reference.
3. **Named Retrieval Logic:**
    - Implement `VaultService.get_item(agent_id, name, category)`.
    - Update the `/outfit` and `/location` commands:
        - If the argument is a known name in the vault, use that asset ID directly.
        - Otherwise, continue with semantic search or generation.
4. **Agent Skill:**
    - Add a `remember_outfit(name)` tool/skill for agents.
    - Usage: If the user says "I love this dress", the agent can call `remember_outfit("red_dress")`.
5. **UI Inventory (Optional but recommended):**
    - The system should be able to list the vault contents for an agent.

## Dev Notes

### Previous Story Insights
- Story 13.6 added the `WEARS` and `IS_IN` relations for real-time state.
- Story 25.2 implemented `visual_asset` table with sémantic search.
- The Vault acts as a "Bookmark" system on top of the sémantic cache.

### Data Models
- **Table `vault`**:
  ```surql
  DEFINE TABLE vault SCHEMAFULL;
  DEFINE FIELD name ON TABLE vault TYPE string;
  DEFINE FIELD agent_id ON TABLE vault TYPE record<subject>;
  DEFINE FIELD asset_id ON TABLE vault TYPE record<visual_asset>;
  DEFINE FIELD category ON TABLE vault TYPE string;
  DEFINE INDEX vault_unique ON TABLE vault FIELDS agent_id, name UNIQUE;
  ```
  [Source: architecture/13-visual-imagination.md#3]

### File Locations
- Service: `apps/h-core/src/services/visual/vault.py`
- Integration: Update `VisualImaginationService` in `apps/h-core/src/services/visual/service.py`.
- Tool: `apps/h-core/src/agents/tools/visual.py`.

### Testing Requirements
- Unit test for `VaultService` CRUD operations.
- Integration test: `/outfit test_vault` should fail initially, then pass after saving an asset with that name.

## Tasks / Subtasks

- [x] **DB Migration** (AC: 1)
    - [x] Update `graph_schema.surql` with the `vault` table definition.
    - [x] Run the migration script or apply to the running instance.
- [x] **Vault Service Implementation** (AC: 2, 3)
    - [x] Create `VaultService` class.
    - [x] Implement `save_item` and `get_item`.
- [x] **Command Integration** (AC: 3)
    - [x] Modify `CommandHandler` in `apps/h-core/src/services/chat/commands.py`.
    - [x] Logic: `if name in vault: use_asset(vault[name]) else: semantic_search(...)`.
- [x] **Agent Tool** (AC: 4)
    - [x] Add `save_to_vault` tool to `BaseAgent`.
    - [x] Update system prompt to explain when to use this tool.
- [x] **Validation**
    - [x] Scenario: User says "Name this outfit 'cyberpunk_ninja'". Agent saves it. User later says "/outfit cyberpunk_ninja". Verify identical asset.

## Dev Agent Record

### Agent Model Used
Gemini 2.5 Flash

### Debug Log
- Defined `vault` table in `graph_schema.surql` with unique index on `(agent_id, name)`.
- Implemented `VaultService` for CRUD operations on named assets.
- Integrated `VaultService` into `VisualImaginationService` constructor.
- Modified `CommandHandler` to check the vault before triggering new generations for `/outfit` and `/location`.
- Added `/vault [agent]` slash command to list saved assets.
- Implemented `save_to_vault` tool in `BaseAgent` allowing agents to persist their visual state.
- Verified with unit tests in `test_25_7_vault.py` and agent tool validation script.

### Completion Notes List
- Agents can now "remember" outfits and locations by naming them.
- Users can trigger these named assets via slash commands, bypassing generation latency and ensuring consistency.
- The system supports multiple categories (garment, background) per agent.

### File List
- `apps/h-core/src/infrastructure/graph_schema.surql` (Modified)
- `apps/h-core/src/services/visual/vault.py` (New)
- `apps/h-core/src/services/visual/service.py` (Modified)
- `apps/h-core/src/services/chat/commands.py` (Modified)
- `apps/h-core/src/domain/agent.py` (Modified)
- `apps/h-core/tests/test_25_7_vault.py` (New)
- `tests/validate_25_7_agent_tool.py` (New)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-27 | 1.0 | Initial draft for Story 25.7 | Bob (SM) |
| 2026-01-28 | 1.1 | Implemented Vault System, Command integration, and Agent Tool | James (Dev) |

### Status
**Status:** Ready for Review