# Story 13.1: Graph Schema Implementation

**Status:** Done

## Story
**As a** System Architect,
**I want** to implement a true Graph database schema in SurrealDB,
**so that** memories are not just isolated documents but connected nodes representing the richness of a mental model.

## Acceptance Criteria
1. **Schema Definition:**
    - Define Node Tables: `fact`, `subject` (user/agent), `concept`.
    - Define Edge Tables: `BELIEVES` (Agent->Fact), `ABOUT` (Fact->Subject/Concept), `CAUSED` (Fact->Fact).
    - Edges MUST be `SCHEMAFULL` to ensure data integrity.
2. **Migration:**
    - Create a script to migrate existing "flat" memories into this new graph structure (best effort).
3. **Insertion Logic:**
    - Update `MemoryConsolidator` to generate Graph insertions (RELATE statements) instead of simple INSERTs.
    - Example: `RELATE agent:lisa->BELIEVES->fact:uuid SET confidence=0.9`.

## Tasks / Subtasks
- [x] Create `apps/h-core/src/infrastructure/graph_schema.surql` (AC: #1)
    - [x] Define tables `fact`, `subject`, `concept`.
    - [x] Define relation `BELIEVES` with fields `confidence`, `strength`, `last_accessed`.
    - [x] Define relations `ABOUT` and `CAUSED`.
- [x] Implement `insert_graph_memory(fact_data)` in `SurrealDbClient` (AC: #1, #3)
    - [x] Use `RELATE` syntax.
- [x] Update `MemoryConsolidator.consolidate()` to use graph logic (AC: #3)
    - [x] Modify prompt to identify subjects and concepts.
    - [x] Implement node/edge creation logic.
- [x] Develop `scripts/migrate_memories_v2_to_v3.py` (AC: #2)
    - [x] Read old `memories` table and relate them to `agent:system` or specific agents if identifiable.

## Dev Notes
- **Relevant Source Tree:** `apps/h-core/src/infrastructure/surrealdb.py`, `apps/h-core/src/domain/memory.py`.
- **SurrealDB syntax:** Use `RELATE <from>-><table_name>-><to>`.
- **Note:** `BELIEVES` edge should carry metadata like `confidence` (0.0 to 1.0) and `last_accessed`.

## Testing
- **Test file location:** `apps/h-core/tests/test_graph_memory.py`
- **Framework:** `pytest`
- **Scenarios:**
    - Verify schema definition runs without error.
    - Verify `RELATE` statements create edges correctly.
    - Verify migration script processes at least one old record correctly.

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `apps/h-core/tests/test_graph_memory.py` passed.

### Completion Notes List
- Defined Graph Schema in `graph_schema.surql` with Nodes (`fact`, `subject`, `concept`) and Edges (`BELIEVES`, `ABOUT`, `CAUSED`).
- Implemented `insert_graph_memory` in `SurrealDbClient` using `RELATE` syntax and `INSERT ... ON DUPLICATE KEY UPDATE` for node upserts.
- Updated `MemoryConsolidator` to use the new graph insertion method.
- Created a migration script `scripts/migrate_memories_v2_to_v3.py` to move old data to the graph structure.
- Verified logic with unit tests.

### File List
- `apps/h-core/src/infrastructure/graph_schema.surql`
- `apps/h-core/src/infrastructure/surrealdb.py`
- `apps/h-core/src/domain/memory.py`
- `scripts/migrate_memories_v2_to_v3.py`
- `apps/h-core/tests/test_graph_memory.py`

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Initial draft for Graph Schema Implementation | Bob (SM) |
| 2026-01-25 | 1.1 | Implemented Graph Schema and logic | James (Dev) |

## QA Results

### Review Date: 2026-01-25
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation is robust and correctly utilizes SurrealDB's graph features. The transition from flat storage to a relational model is well-handled by the `insert_graph_memory` abstraction. The migration script provides a safe path for existing data.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Unit + Live Verification)
- All ACs Met: [✓]

### Gate Status
Gate: PASS → docs/qa/gates/13.1-graph-schema.yml
Risk profile: N/A (Foundational architectural change)
NFR assessment: PASS (Graph integrity ensured via SCHEMAFULL)

### Recommended Status
**Status:** Done