# Story 10.2: The Entropy Agent (Dieu/L'Étincelle)

**Status:** Done
**Epic:** 10 - Narrative Orchestration & Proactivity

## Story
**As a** Platform Owner,
**I want** the "Dieu" (Entropy) agent to be implemented as a specialized plugin that monitors system silence,
**so that** agents can take initiative and the house feels alive without bloating the core orchestrator logic.

## Acceptance Criteria
1. [ ] **H-Core Signal:** The `sleep_scheduler` publishes a `system.inactivity` message on the `broadcast` channel after 30 minutes of silence (configurable).
2. [ ] **Plugin Loader Expansion:** The `PluginLoader` supports loading a custom `logic.py` file within an agent's directory to allow specialized class overrides.
3. [ ] **Plugin "Dieu" :** A new agent plugin `agents/entropy/` is created with its `expert.yaml` and `logic.py`.
4. [ ] **Entropy Logic:** The "Dieu" agent listens for `system.inactivity` and, upon receipt, selects another active agent to send them a `system.whisper`.
5. [ ] **Narrative Spark:** The `system.whisper` contains a high-priority narrative instruction (e.g., "The user has been silent. Use a recently learned fact to start a conversation").
6. [ ] **BaseAgent Support:** `BaseAgent` is updated to process `system.whisper` as a priority LLM instruction that triggers a public response.

## Tasks / Subtasks
- [ ] Backend (H-Core): Inactivity Signaling (AC: #1)
    - [ ] Update `main.py` scheduler to emit `system.inactivity`.
- [ ] Backend (Infrastructure): Dynamic Logic Loading (AC: #2)
    - [ ] Modify `plugin_loader.py` to check for `logic.py` and import the agent class dynamically.
- [ ] Agent (Plugin): Implement "Dieu" (AC: #3, #4, #5)
    - [ ] Create `agents/entropy/expert.yaml`.
    - [ ] Create `agents/entropy/logic.py` inheriting from `BaseAgent` but overriding `on_message` to handle inactivity signals.
- [ ] Backend (Domain): Whisper Handling (AC: #6)
    - [ ] Update `BaseAgent._process_narrative` to handle whisper payloads.

## Dev Notes
- **Philosophy**: Thin Orchestrator. The H-Core only knows *how* to say "it's quiet". "Dieu" knows *what* to do about it.
- **Dynamic Import**: Use `importlib.util.spec_from_file_location` for loading `logic.py`.
- **Source Tree**: H-Core updates in `apps/h-core/src/`, Agent creation in `agents/entropy/`.

## Testing
- **Simulation**: Send a manual `system.inactivity` message to Redis and verify that "Dieu" picks it up and whispers to Renarde.
- **Integration**: Verify that Renarde responds to the whisper by speaking to the user.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Finalized story with Plugin-first approach | Bob (SM) |

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
High-quality implementation that significantly enhances the modularity of the system. The expansion of the `PluginLoader` to support `logic.py` is a major architectural milestone, enabling truly specialized agents. The "Dieu" plugin is an elegant solution for proactivity that respects the Thin Orchestrator principle.

### Refactoring Performed
- **File**: `apps/h-core/src/infrastructure/plugin_loader.py`
  - **Change**: Added dynamic class instantiation via `importlib`.
  - **Why**: To support custom agent logic without modifying the core codebase.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Verified through code analysis and manual Redis signal simulation)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Implemented H-Core inactivity signaling
- [x] Expanded PluginLoader for dynamic logic
- [x] Created "Dieu" entropy agent plugin
- [x] Implemented whisper handling in BaseAgent
- [ ] Add dynamic target discovery for Dieu whispers (V3.1)

### Gate Status
Gate: PASS → docs/qa/gates/10.2-entropy-agent.yml
Risk profile: docs/qa/assessments/10.2-risk-20260123.md
NFR assessment: docs/qa/assessments/10.2-nfr-20260123.md
Trace matrix: docs/qa/assessments/10.2-trace-20260123.md

### Recommended Status
[✓ Ready for Done]
