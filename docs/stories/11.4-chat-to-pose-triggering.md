# <!-- Powered by BMADâ„¢ Core -->
# Story 11.4: Chat-to-Pose Triggering (MVP Logic)

## Status
- **Status:** InProgress

## Story
**As a** User,
**I want** the agent's visual expression to change automatically based on tags in their chat messages,
**so that** the interaction feels immersive and emotionally resonant.

## Acceptance Criteria
1. The UI must load `public/assets/backgrounds/background.png` as the default background on startup.
2. The `Renderer` must detect `[pose:X]` tags within `narrative.text` message payloads.
3. When a tag is detected, the `Renderer` must update the agent's body/face layers using the asset: `/assets/agents/{agent_id}/{agent_id}_{suffix}_01.png`.
4. The mapping between `pose` tags and `suffix` must follow Story 11.1 (e.g., `happy` -> `happy`, `idle` -> `neutral`).
5. The `[pose:X]` tag itself must be stripped from the text displayed in the dialogue bubble and chat history.
6. The system should default to the `neutral` pose if no tag is present or if the agent is unknown.

## Tasks / Subtasks
- [ ] Implement Pose Detection Logic in `renderer.js` (AC: 2, 5)
    - [ ] Add a regex to extract `[pose:X]` from text strings.
    - [ ] Create a `processPose(agentId, text)` method that returns cleaned text and identified pose.
- [ ] Update Asset Loading Logic (AC: 1, 3, 4)
    - [ ] Map pose names to file suffixes (e.g., `idle` -> `neutral`).
    - [ ] Update `Renderer.render()` or `handleMessage()` to set background/agent layers.
    - [ ] Ensure the background layer loads `background.png`.
- [ ] Validation (AC: 6)
    - [ ] Mock a `narrative.text` message with a `[pose:happy]` tag and verify visual change.
    - [ ] Verify that the tag is not visible in the UI.

## Dev Notes
- **Source Artifacts:**
    - `docs/stories/11.1-expression-mapping.md`: Official pose-to-suffix mapping. [Source: docs/stories/11.1-expression-mapping.md]
    - `docs/visual-style-guide.md`: Asset paths and integration notes. [Source: docs/visual-style-guide.md]
- **Files to Modify:**
    - `apps/a2ui/js/renderer.js`: Main logic for state and visual updates.
    - `apps/a2ui/js/network.js`: Routing of messages to the renderer.

### Testing
- **Test file location:** `tests/validate_11_4.py`
- **Test standards:** Browser-based verification (Playwright) of image `src` updates after message injection.
