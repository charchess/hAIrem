# Story 25.5: Outils Narratifs & Commandes Slash

**Status:** Ready for Review
**Epic:** 25 - Visual Imagination

## Story
**As a** User or Agent,
**I want** to trigger image generation via commands or tools,
**so that** I can visualize the conversation in real-time.

## Acceptance Criteria
1. **Agent Tool:**
    - Register a `generate_image` tool for agents (Electra, Lisa, etc.). [Source: prd/epic-25-visual-imagination.md#2.1]
    - Tool should accept `prompt` and optional `style`.
2. **Slash Command:**
    - Implement `/imagine [prompt]` in the chat interface. [Source: prd/epic-25-visual-imagination.md#2.1]
3. **Async Notification:**
    - Use Redis (H-Link) to notify the bridge/frontend when a generation is started and finished. [Source: architecture/13-visual-imagination.md#5]
4. **Validation:**
    - Agents should use the tool when describing a scene or showing something.

## Dev Notes

### Previous Story Insights
- `VisualProvider` (25.1) and `AssetManager` (25.2) are the underlying engines.
- Tool registration happens in `apps/h-core/src/agents/base.py` or individual expert configs.

### H-Link Message
- Type: `visual.asset`
- Payload: `url`, `alt_text`, `asset_type`. [Source: architecture/13-visual-imagination.md#5]

### File Locations
- Tool Definition: `apps/h-core/src/agents/tools/visual.py` (New).
- Slash Command: `apps/h-core/src/services/chat/commands.py`.

### Testing Requirements
- Test tool execution in isolation.
- Verify Redis message publication on generation completion.

- [x] **Agent Tool Registration** (AC: 1)
    - [x] Implement `generate_image` tool logic (added to `BaseAgent` for all agents).
    - [x] Add to the system prompt/tool definition for agents.
- [x] **Slash Command implementation** (AC: 2)
    - [x] Add `/imagine` to the command registry in H-Core (implemented in `CommandHandler`).
    - [x] Logic should call the visual service and respond with "Imagining...".
- [x] **Redis Broadcasting** (AC: 3)
    - [x] Implement `notify_visual_asset(asset)` that publishes to the `broadcast` channel (in `VisualImaginationService`).
- [x] **Integration Test**
    - [x] Mock an agent calling the tool and verify the Redis output.

## Dev Agent Record

### Agent Model Used
Gemini 2.5 Flash

### Debug Log
- Refactored `VisualImaginationService` to handle the full lifecycle (generate, download, index, notify).
- Integrated `VisualImaginationService` into `BaseAgent` and `Dreamer`.
- Added `generate_image` tool to `BaseAgent`.
- Implemented `CommandHandler` for global slash commands and integrated it into `main.py` via `command_worker`.
- Added `VISUAL_ASSET` and `VISUAL_RAW_PROMPT` to `MessageType` enum.
- (FR25.8) Implemented `RAW_PROMPT` broadcast in `VisualImaginationService` for observability.
- (FR25.12) Implemented "Burning Memory" injection in `BaseAgent` for constant visual self-awareness.
- Verified everything with unit tests in `test_visual_tools.py` and `test_25_5_finalization.py`.

### Completion Notes List
- All agents now have access to the `generate_image` tool.
- Users can use `/imagine [prompt]` in the chat to trigger immediate generation.
- Visual asset generations are now broadcasted via Redis for frontend consumption.
- (FR25.8) Raw generation prompts are now broadcasted to the UI for technical audit.
- (FR25.12) Agents are now automatically aware of their current outfit and location in every interaction.

### File List
- `apps/h-core/src/models/hlink.py` (Modified)
- `apps/h-core/src/services/visual/service.py` (Modified)
- `apps/h-core/src/services/visual/dreamer.py` (Modified)
- `apps/h-core/src/domain/agent.py` (Modified)
- `apps/h-core/src/infrastructure/plugin_loader.py` (Modified)
- `apps/h-core/src/main.py` (Modified)
- `apps/h-core/src/services/chat/commands.py` (Modified)
- `apps/h-core/tests/test_visual_tools.py` (Modified)
- `apps/h-core/tests/test_25_5_finalization.py` (New)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-27 | 1.0 | Initial draft for Story 25.5 | Bob (SM) |
| 2026-01-27 | 1.1 | Implemented tools, commands and broadcasting | James (Dev) |
| 2026-01-28 | 1.2 | Added FR25.8 (RAW_PROMPT broadcast) and FR25.12 (Burning Memory) | James (Dev) |

### Status
**Status:** Ready for Review

## QA Results

### Quality Gate Decision: PASS ðŸ§ª

**Review Date:** 2026-01-28
**Reviewer:** Quinn (QA)

#### Analysis:
Slash commands (/imagine, /outfit) are fully functional. The log broadcast system provides high visibility for debugging.

#### Gate Decision File:
`docs/qa/gates/25.5-tools-commands.yml`

#### Status
[âœ“ Done]

---

### Comprehensive Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is robust and follows the established asynchronous patterns of the project. The integration of "Burning Memory" into `BaseAgent` is a significant enhancement for agent situational awareness. The `VisualImaginationService` correctly handles the full lifecycle of asset generation, including potential post-processing (background removal) and indexing.

### Refactoring Performed

No immediate refactoring was performed as the code is clean and follows standards. Recommendations for future improvements are noted.

### Compliance Check

- Coding Standards: [âœ“] (Async/Await, Type Hints, Logging)
- Project Structure: [âœ“] (Logic in services/domain, infrastructure isolation)
- Testing Strategy: [âœ“] (Unit tests with mocks for external services)
- All ACs Met: [âœ“]

### Improvements Checklist

- [x] Implement background processing for slash commands to prevent blocking the router.
- [x] Add observability for raw prompts (FR25.8).
- [x] Inject transient state (outfit, location) into agent system prompts (FR25.12).
- [ ] Install `rembg` to enable background removal for poses.
- [ ] Decouple `CommandHandler` from hardcoded agent names.

### Security Review

No security vulnerabilities identified. Commands are validated and executed in a controlled manner.

### Performance Considerations

Generation is handled asynchronously. Background removal uses a thread executor to avoid blocking the event loop.

### Gate Status

Gate: PASS â†’ docs/qa/gates/25.5-tools-commands.yml
Quality Score: 90/100

### Recommended Status

[âœ“ Ready for Done]
