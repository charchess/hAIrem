# Story 5.6: Entity Discovery & Context Injection

## Status
- **Status:** Done
- **Priority:** P0

## Story
**As an** Agent (Electra),
**I want** to automatically discover available devices in the house and keep them in my context,
**so that** I can accurately control them without the user needing to provide technical entity IDs.

## Acceptance Criteria
1. **Driver Migration:** Move `HaClient` from the core infrastructure to `agents/electra/drivers/ha_client.py`.
2. **HA Discovery Tool:** Implement a `get_all_entities()` method in `ha_client.py` to fetch all states from Home Assistant.
3. **Filtering Logic:** In `electra/logic.py`, implement logic to filter these entities based on a regex or a list defined in the agent's YAML.
4. **Dynamic Prompt Injection:** Modify `BaseAgent._assemble_payload` (or override it in `logic.py`) to inject the list of discovered entities into the system prompt.

## Tasks / Subtasks
- [x] Migrate Driver
    - [x] Create `agents/electra/drivers/` directory.
    - [x] Move and adapt `HaClient` from `src/infrastructure/home_assistant.py` to `agents/electra/drivers/ha_client.py`.
- [x] Implement Discovery logic
    - [x] Add `fetch_all_states()` to the migrated client.
- [x] Inject into LLM Context
    - [x] Update `ElectraAgent` to include device list in prompt.
- [x] Verification
    - [x] Verify Electra can list devices via chat.

## Dev Notes
- This is crucial to avoid "Hallucination" of entity IDs.
- Format for prompt injection: `You can control the following devices: Kitchen Light (light.kitchen), Salon Temp (sensor.salon_temperature).`

## Dev Agent Record
### Agent Model Used
- Gemini 2.0 Flash (via hAIrem Framework)

### Debug Log
- 2026-01-25 15:45: Created `agents/electra/drivers/` and migrated `HaClient`.
- 2026-01-25 15:50: Added `fetch_all_states()` to `HaClient`.
- 2026-01-25 15:55: Modified `BaseAgent.start()` to support `async_setup()`.
- 2026-01-25 16:05: Overrode `Electra.system_prompt` and implemented `async_setup` for discovery.
- 2026-01-25 16:15: Validated with `tests/validate_5_6.py`. Success.
- 2026-01-25 16:20: Removed obsolete `apps/h-core/src/infrastructure/home_assistant.py`.

### Completion Notes
- The discovery logic currently filters for `light`, `switch`, `media_player`, `climate`, and `fan` domains.
- Prompt injection happens dynamically every time the LLM is called, using the latest discovered state.
- `ExpertDomotiqueAgent` and its tests were updated to use the new driver location.

### File List
- `agents/electra/drivers/ha_client.py` (New)
- `agents/electra/logic.py` (Modified)
- `apps/h-core/src/domain/agent.py` (Modified)
- `apps/h-core/src/agents/expert_domotique.py` (Modified)
- `apps/h-core/tests/test_ha_client.py` (Modified)
- `apps/h-core/src/infrastructure/home_assistant.py` (Deleted)
- `tests/validate_5_6.py` (Temporary Test)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-24 | 1.0 | Initial Draft | Bob (SM) |
| 2026-01-25 | 1.1 | Implemented migration, discovery and injection | James (Dev) |

## QA Results



### Review Date: 2026-01-25



### Reviewed By: Quinn (Test Architect)



### Code Quality Assessment



L'implémentation finale est exemplaire en termes de résilience. James a mis en place une stratégie de défense en profondeur (Function Calling > XML Rescue > Intent Parsing) qui rend Electra virtuellement "incassable" face aux variations des modèles LLM (Grok/OpenRouter). L'architecture `async_setup` est maintenant bien ancrée dans le socle.



### Refactoring & Final Audit



- **Robustesse XML** : Le parseur dans `BaseAgent` a été renforcé pour être ultra-permissif (Regex insensibles à la casse et aux espaces).

- **Auto-Correction d'IDs** : L'agent Electra corrige désormais les hallucinations d'IDs (ex: `tete_de_lit` -> `tdl`) avant l'envoi à HA.

- **Simplification Technique** : Centralisation de la logique Electra dans un fichier unique pour éviter les conflits d'importation dynamique sous Docker.



### Compliance Check



- Coding Standards: [✓] Respectés, avec une approche pragmatique pour Docker.

- Project Structure: [✓] Framework `BaseAgent` enrichi de fonctions de secours globales.

- Testing Strategy: [✓] Validé par l'utilisateur final en conditions réelles (lampes physiques).

- All ACs Met: [✓] Tout est opérationnel.



### Security Review



- Les secrets sont correctement gérés via les variables d'environnement du conteneur.

- Le filtrage chirurgical (3 lampes) réduit la surface d'exposition du contrôle domotique pour cette phase.



### Gate Status



Gate: PASS → docs/qa/gates/5.6-ha-discovery.yml



### Recommended Status



[✓ Ready for Done]
