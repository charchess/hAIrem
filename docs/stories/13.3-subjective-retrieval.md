# Story 13.3: Subjective Retrieval (Contextual Search)

**Status:** Done
**Epic:** 13 - Deep Cognitive Architecture

## Story
**As an** Agent (e.g., Lisa),
**I want** to recall memories that *I* specifically believe in or that are universal,
**so that** my personality and bias remain consistent and distinct from other agents.

## Acceptance Criteria
1. **Subjective Query:**
    - The `recall_memory` tool must filter facts based on the executing agent's perspective.
    - Path: `agent:{my_id}->BELIEVES->fact`.
2. **Universal Facts:**
    - Some facts are linked to `agent:system` (Universal). All agents can access these.
    - Query should combine: `(agent:{my_id}->BELIEVES->fact) UNION (agent:system->BELIEVES->fact)`.
3. **Strength Filtering:**
    - Results must be filtered to exclude "faded" memories (`strength > 0.3`).
4. **Tool Abstraction:**
    - The LLM should not need to pass its own ID; `BaseAgent` should inject it automatically.

## Tasks / Subtasks
- [x] Modify `SurrealDbClient.semantic_search()` to accept an `agent_id` parameter (AC: #1, #2)
    - [x] Update query to traverse graph: `SELECT ->BELIEVES[WHERE strength > 0.3 AND (in = $agent_id OR in = agent:system)]->fact.* FROM $agent_id`.
- [x] Update `BaseAgent.recall_memory(query)` (AC: #4)
    - [x] Inject `self.config.name` into the DB call.
- [x] Update `MemoryConsolidator` to link "User preference" facts to `agent:system` by default, and "Agent opinion" facts to the specific agent (AC: #2).

## Dev Notes
- **SurrealDB traversal:** `SELECT ->BELIEVES->fact.* FROM agent:lisa`.
- **Tech Stack:** Leveraging SurrealDB's Graph features is mandatory here.

## Testing
- **Test file location:** `apps/h-core/tests/test_subjective_recall.py`
- **Framework:** `pytest`
- **Scenarios:**
    - Verify Lisa recalls a fact she "believes" but Electra does not.
    - Verify all agents recall a "system" fact.
    - Verify faded facts are not returned.

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `apps/h-core/tests/test_subjective_recall.py` passed.

### Completion Notes List
- Updated `SurrealDbClient.semantic_search` to support graph-based filtering using `<-BELIEVES` edges.
- Facts are now filtered by the beliefs of the specific agent OR the universal 'system' agent.
- `BaseAgent.recall_memory` now automatically passes the agent's name to the search tool.
- `MemoryConsolidator` now correctly assigns 'user' facts to the 'system' belief by default.
- Verified logic with unit tests.

### File List
- `apps/h-core/src/infrastructure/surrealdb.py`
- `apps/h-core/src/domain/agent.py`
- `apps/h-core/src/domain/memory.py`
- `apps/h-core/tests/test_subjective_recall.py`

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Initial draft for Subjective Retrieval | Bob (SM) |
| 2026-01-25 | 1.1 | Implemented Subjective Graph Retrieval | James (Dev) |

## QA Results

### Review Date: 2026-01-26
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Le passage à une recherche sémantique filtrée par le graphe est une avancée majeure pour la personnalité des agents. L'utilisation de `<-BELIEVES` dans la query SurrealDB est efficace et propre. L'inclusion automatique des faits système garantit que les agents partagent une base de connaissances commune tout en gardant leurs propres biais.

### Compliance Check
- Coding Standards: [✓] Abstraction de la DB respectée.
- Project Structure: [✓]
- Testing Strategy: [✓] Tests unitaires validant les divergences de rappel entre agents.
- All ACs Met: [✓]

### Gate Status
Gate: PASS → docs/qa/gates/13.3-subjective-retrieval.yml

### Recommended Status
**Status:** Done

## Status
Done
