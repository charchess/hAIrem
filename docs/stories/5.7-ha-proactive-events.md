# Story 5.7: Proactive HA Event Listeners (WebSocket)

## Status
- **Status:** Done
- **Priority:** P1

## Story
**As a** User,
**I want** the agents to react to changes in the house (e.g. motion detected, lights turned on manually),
**so that** the interaction feels proactive and the agents are aware of the environment's state.

## Acceptance Criteria
1. **HA WebSocket Client:** Implement a persistent WebSocket connection to Home Assistant in the agent's driver.
2. **Proactive Monitoring:** Use the new `self.spawn_task()` method in `Electra.setup()` to launch the event listener.
3. **Agent Reaction:** Implement an `on_ha_event` handler that can trigger narrative comments.

## Tasks / Subtasks
- [x] Implement WebSocket monitoring in the agent driver.
- [x] Use `spawn_task` to run the listener in the background.
- [x] Implement narrative reaction logic.
- [x] Verification
    - [x] Manually toggle a switch in HA and verify Electra comments on it in hAIrem.

## Dev Notes
- Need to use `websockets` or `aiohttp` for the HA WebSocket connection.
- Be careful with "Chatter": agents shouldn't comment on *every* change, only important ones.

## Dev Agent Record
### Agent Model Used
- Gemini 2.0 Flash (via hAIrem Framework)

### Debug Log
- 2026-01-25 17:30: Added `spawn_task` and task tracking to `BaseAgent`.
- 2026-01-25 17:45: Implemented `HaClient` with WebSocket support in `electra/logic.py`.
- 2026-01-25 18:05: Fixed WebSocket URL (`/api/websocket`).
- 2026-01-25 18:15: Validated live connection and proactive response triggering.
- 2026-01-25 18:30: Added friendly name mapping for better immersion.

### Completion Notes
- Electra now listens to `state_changed` events for bedroom lights.
- Authentication flow fixed: wait for `auth_required` then send token.
- Mapping added to translate technical IDs to human-friendly names in comments.
- Background tasks are cleanly canceled on agent shutdown.

### File List
- `apps/h-core/src/domain/agent.py` (Modified)
- `agents/electra/logic.py` (Modified)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-24 | 1.0 | Initial Draft | Bob (SM) |
| 2026-01-25 | 1.1 | Implemented proactive WebSocket listeners | James (Dev) |

## QA Results

### Review Date: 2026-01-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

L'implémentation du pont WebSocket est solide. James a correctement géré le flux d'authentification spécifique à HA. L'ajout du système `spawn_task` dans le framework est une amélioration architecturale majeure qui ouvre la voie à d'autres agents autonomes.

### Refactoring Performed

- **Auto-Reconnection** : J'ai ajouté une boucle de reconnexion automatique (`while True` avec exponential backoff simulé) dans `listen_events`. Cela garantit que si Home Assistant redémarre, Electra se reconnectera toute seule sans intervention humaine.
- **Robustesse du Loop** : Gestion des messages `CLOSED` et `ERROR` de `aiohttp` pour déclencher proprement la reconnexion.

### Compliance Check

- Coding Standards: [✓] Asynchronicité respectée.
- Project Structure: [✓] Intégration propre dans le driver agent.
- Testing Strategy: [✓] Validé en conditions réelles par l'utilisateur.
- All ACs Met: [✓] Monitoring proactif opérationnel.

### Gate Status

Gate: PASS → docs/qa/gates/5.7-ha-proactive-events.yml

### Recommended Status

[✓ Ready for Done]