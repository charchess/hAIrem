# Story 13.5: Restore Sleep & Cognition Orchestration (Regression Fix)

**Status:** Done
**Epic:** 13 - Deep Cognitive Architecture / 25 - Visual Imagination

## Story
**As a** System Architect,
**I want** to restore the background orchestration for cognitive consolidation and proactive dreaming,
**so that** the agents' long-term memory and visual imagination are active automatically.

## Acceptance Criteria
1. **Background Worker:**
    - Re-implement a `sleep_cycle_worker` in `apps/h-core/src/main.py`.
    - The worker must be a non-blocking `asyncio.Task` started in `main()`.
    - It must handle exceptions gracefully to avoid crashing the whole core.
2. **Cognitive Consolidation (from Story 10.1):**
    - **Trigger 1 (Time-based):** Call `consolidator.consolidate()` every hour (configurable via `SLEEP_CYCLE_INTERVAL`, default 3600s).
    - **Trigger 2 (Event-based):** Listen for `MessageType.SYSTEM_STATUS_UPDATE` with payload `{"status": "SLEEP_START"}` on the broadcast channel.
3. **Memory Decay (from Story 13.2):**
    - Call `consolidator.apply_decay()` once every 24 hours (e.g., at 03:00 AM system time).
4. **Proactive Dreaming (from Story 25.3):**
    - Call `dreamer.prepare_daily_assets()` immediately after the daily decay cycle (e.g., at 03:05 AM).
5. **Observability:**
    - Broadcast a `SYSTEM_LOG` (INFO) when a cycle starts and ends.
    - Log the number of facts consolidated.

## Dev Notes
- **Context:** This code was previously present but seems to have been removed during Epic 23/25 refactoring.
- **Reference:** Check `apps/h-core/src/domain/memory.py` for method signatures.
- **Components:** `consolidator` and `dreamer` are already initialized in `main.py`, just not used.
- **Time Check:** Use `datetime.now().hour` to determine if it's the "Daily Deep Sleep" (e.g., 3 AM) vs just an hourly nap.

## Tasks / Subtasks
- [x] **Main Loop:** Define `async def sleep_cycle_worker()` in `main.py`.
- [x] **Orchestration Logic:**
    - Loop forever with `await asyncio.sleep(60)` (check every minute).
    - If `last_run > 1h`: Run `consolidate()`.
    - If `current_hour == 3` and `daily_run_done is False`: Run `apply_decay()` and `prepare_daily_assets()`.
- [x] **Event Listener:** Update the `router` in `main.py` to watch for `SLEEP_START` signals and trigger the worker logic immediately.
- [x] **Startup:** Add `asyncio.create_task(sleep_cycle_worker())` to the `tasks` list in `main()`.
- [x] **Validation:**
    - Start the stack.
    - Wait for the first hourly run (or force it via event).
    - Verify `SYSTEM_LOG` output in Redis/UI.

## Dev Agent Record

### File List
- `apps/h-core/src/main.py`
- `tests/verify_13_5.py`

### Change Log
- Added `sleep_cycle_worker` to `apps/h-core/src/main.py` for periodic cognitive tasks.
- Implemented `SLEEP_START` event handling in `router` via global `asyncio.Event`.
- Configured 3 AM daily maintenance (Decay + Proactive Dreaming).
- Validated logic with `tests/verify_13_5.py`.

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation restores the critical sleep and cognition orchestration logic that was previously lost. The `sleep_cycle_worker` correctly handles both time-based (hourly/daily) and event-based triggers. The logic for preventing duplicate daily runs (using `daily_run_done` flag) is sound. Exception handling within the worker loop ensures system resilience.

One minor observation: The `sleep_cycle_worker` is added to the main task list but isn't strictly managed for clean shutdown (though `main.py` relies on `asyncio.run` catching keyboard interrupts usually). This is acceptable for the current architecture.

### Refactoring Performed

- None required during review. Code adheres to existing structure in `main.py`.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Verified with `tests/verify_13_5.py` which mocks the logic effectively)
- All ACs Met: [✓]

### Improvements Checklist

- [x] Re-implemented `sleep_cycle_worker`
- [x] Added `SLEEP_START` event listener
- [x] Configured 3 AM daily maintenance
- [ ] Future: Extract `sleep_cycle_worker` to its own service/module if `main.py` grows too large.

### Security Review

No new security risks introduced. The worker operates internally and uses existing secure clients (Redis, SurrealDB).

### Performance Considerations

The worker sleeps for 60 seconds between checks, introducing negligible overhead.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/epic-13.13.5-restore-sleep-orchestration.yml
Risk profile: Skipped (Low Risk Regression Fix)
NFR assessment: Skipped (Low Impact)

### Recommended Status

[✓ Ready for Done]
