# Story 13.4: Conflict Synthesis

**Status:** InProgress

## Story
**As a** System,
**I want** to detect when a new observation contradicts an old belief,
**so that** I can evolve my understanding rather than holding two opposing views.

## Acceptance Criteria
1. **Conflict Detection:**
    - During memory consolidation, before inserting a new fact, the system must check for semantic similarity (> 0.85) with existing facts about the same subject.
2. **Conflict Resolution Loop:**
    - If a potential conflict is detected, trigger an LLM "Resolution Prompt":
      - "Fact A: User likes tea (Strength 0.9)"
      - "Fact B: User says they hate tea now."
      - "Resolution: User changed their preference. Synthesize: User no longer likes tea."
3. **Graph Update:**
    - If resolution results in a "Override": weaken/delete old edge and create new synthesis.
    - If resolution results in a "Merge": update old edge metadata.

## Tasks / Subtasks
- [x] Implement `ConflictResolver` service in `apps/h-core/src/domain/memory.py` (AC: #2)
    - [x] Design the "Synthesis Prompt".
- [x] Integrate conflict check in `MemoryConsolidator.consolidate()` (AC: #1)
    - [x] Perform vector search for each new fact.
- [x] Implement `merge_or_override_fact()` in `SurrealDbClient` (AC: #3).

## Dev Notes
- **Logic:** This is the most complex part of the "Mind". It prevents the database from becoming a trash can of old, irrelevant facts.
- **Reference:** Refers to architecture/4-modles-de-donnes-mmoire-subjective.md section on "Syntèse".

## Testing
- **Test file location:** `apps/h-core/tests/test_conflict_resolution.py`
- **Framework:** `pytest`
- **Scenarios:**
    - Insert "User likes coffee". Then insert "User hates coffee". Verify synthesis "User changed mind".
    - Verify that complementary facts (User likes coffee + User likes milk) are NOT treated as conflicts.

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `apps/h-core/tests/test_conflict_resolution.py` passed.

### Completion Notes List
- Implemented `ConflictResolver` service to handle contradictory facts using LLM synthesis.
- Integrated conflict detection in `MemoryConsolidator.consolidate()` using vector similarity (> 0.85).
- Implemented `merge_or_override_fact` in `SurrealDbClient` to handle synthesis updates in the graph.
- Verified logic with unit tests.

### File List
- `apps/h-core/src/domain/memory.py`
- `apps/h-core/src/infrastructure/surrealdb.py`
- `apps/h-core/tests/test_conflict_resolution.py`

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Initial draft for Conflict Synthesis | Bob (SM) |
| 2026-01-25 | 1.1 | Implemented Conflict Detection and Resolution | James (Dev) |

## QA Results

### Review Date: 2026-01-26
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
L'implémentation du `ConflictResolver` est résiliente. La gestion des blocs de code JSON retournés par le LLM (nettoyage des tags markdown) est bien gérée. Le flux dans `MemoryConsolidator` qui interrompt l'insertion standard en cas de conflit pour appeler le resolver est logique et bien testé.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] Tests unitaires simulant des contradictions réelles (ex: "aime le café" vs "déteste le café").
- All ACs Met: [✓]

### Gate Status
Gate: PASS → docs/qa/gates/13.4-conflict-synthesis.yml

### Recommended Status
**Status:** Done

## Status
Done
