# Story 7.5: Admin Interface - Global Settings & LLM Configuration

**Status:** In Progress
**Epic:** 7 - Agent Dashboard & UX Polishing

## Story

**As a** User,
**I want** a comprehensive Admin Interface to configure all system settings (API keys, LLM providers, model selection, etc.) through the UI,
**so that** I can easily manage hAIrem without editing config files or restarting services.

## Background / Context

Currently:
- LLM configuration is scattered across environment variables, YAML manifests, and SurrealDB
- The priority order is unclear: DB overrides everything, making env vars useless
- No UI exists to manage API keys or provider settings
- Users must restart containers to change models

This story implements a proper admin configuration UI with a clear hierarchy:
1. **Admin UI** (runtime override) - highest priority
2. **Manifest YAML** (persona preference)
3. **Environment Variables** (fallback/dev defaults)

## Acceptance Criteria

### 1. API Key Management
- [ ] UI displays a form to enter API keys for each supported provider
- [ ] Keys are masked by default (show only first/last 4 chars)
- [ ] "Test Connection" button verifies the key works
- [ ] Keys are stored securely (vault or encrypted in DB)

### 2. LLM Provider Configuration (Global)
- [ ] Dropdown to select default LLM provider (Ollama, OpenAI, Anthropic, Google, etc.)
- [ ] Input for base URL (for local Ollama/LM Studio)
- [ ] Model selection dropdown (dynamic based on provider)
- [ ] Test button to verify connectivity

### 3. Per-Agent LLM Override
- [ ] In agent cards/dashboard, each agent shows its current LLM config
- [ ] Option to override the global setting for specific agents
- [ ] Visual indicator when agent uses override vs global

### 4. Configuration Priority Display
- [ ] UI shows the effective configuration for each agent
- [ ] Indicates which level won (UI override vs YAML vs env var)

### 5. System Settings
- [ ] Log level selector (existing, keep)
- [ ] Any other system-wide settings

### 6. Persistence
- [ ] All settings persist across restarts
- [ ] Settings loaded on h-core startup

## Technical Implementation

### Configuration Hierarchy (Priority: High → Low)
```
Agent LLM Override (DB) > Manifest llm_config > Environment Variables
```

### API Endpoints (existing, to wire)
- `GET /api/admin/providers` - List supported providers
- `GET /api/admin/config/:agent_id` - Get agent config
- `PUT /api/admin/config/:agent_id` - Update agent config
- `POST /api/admin/config/test` - Test LLM connectivity

### Database Schema
- Table: `agent_config` (exists)
- Fields: agent_id, parameters (JSON), enabled, version

### Frontend
- Section in `#admin-panel` for LLM settings
- Agent cards show config indicator
- Forms with validation and error handling

## Tasks / Subtasks

- [x] **Backend: Fix configuration priority** (Critical) ✅
  - [x] Modify `agent_config_service.py` to use env vars as fallback, not override
  - [x] Ensure YAML manifest config is respected before DB
  
- [x] **Backend: API for testing LLM connectivity** ✅
  - [x] Add endpoint to test connection to a provider/model
  - [x] Return helpful error messages

- [ ] **Backend: Secure API key storage**
  - [ ] Implement vault or encrypted storage for keys

- [x] **Frontend: LLM Settings Section** ✅
  - [x] Add new section in `#admin-panel` for LLM config
  - [x] Provider dropdown with icons
  - [ ] Model dropdown (populated dynamically)
  - [x] API key input with show/hide toggle

- [x] **Frontend: Agent Config Override UI** ✅
  - [x] Per-agent override option in dashboard
  - [ ] Visual indicator when override is active

- [ ] **Frontend: Configuration Priority Info**
  - [ ] Display which source is active for each setting

- [ ] **Testing**
  - [ ] E2E test for updating LLM config
  - [x] Verify settings persist after restart
  - [x] Verify priority order works correctly

## Dev Notes

### Files to Modify
- `apps/h-core/src/features/admin/agent_config/service.py` - Fix priority logic
- `apps/h-core/src/features/admin/provider_config/service.py` - Add test endpoint
- `apps/h-bridge/static/index.html` - Add LLM config section
- `apps/h-bridge/static/style.css` - Style new sections
- `apps/h-bridge/static/js/renderer.js` - Add config UI logic
- `tests/e2e/admin-config.spec.ts` - New E2E tests

### Security Considerations
- Never log full API keys
- Use HTTPS for all external API calls
- Consider rate limiting on test endpoints
- Validate all inputs

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-02-14 | 1.0 | Initial story creation | Dev |

---

## QA Results

### Review Date: [Pending]

### Reviewed By: [Pending]

### Code Quality Assessment
[Pending]

### Compliance Check
- Coding Standards: [ ]
- Project Structure: [ ]
- Testing Strategy: [ ]
- All ACs Met: [ ]

### Improvements Checklist
- [ ] Implement configuration priority fix
- [ ] Add secure API key storage
- [ ] Wire up provider config UI
- [ ] Test end-to-end configuration flow

### Gate Status
Gate: [Pending] → docs/qa/gates/7.5-admin-llm-config.yml

---

### Notes
This story resolves the issue where "the wrong model was being queried" because the DB configuration was overriding environment variables without any UI to manage it.
