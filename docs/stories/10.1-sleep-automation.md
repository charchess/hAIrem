# Story 10.1: Sleep Automation & Scheduling

**Status:** Done
**Epic:** 10 - Narrative Orchestration & Proactivity

## Story
**As a** Platform Owner,
**I want** the cognitive consolidation process (Sleep Cycle) to run automatically in the background,
**so that** agents are constantly learning and evolving without requiring manual intervention via the API.

## Acceptance Criteria
1. [x] A background worker/task is implemented within the H-Core orchestrator.
2. [x] The `MemoryConsolidator` is triggered automatically every hour (configurable via `SLEEP_CYCLE_INTERVAL`).
3. [x] A secondary trigger is implemented: if no user message is received for 15 minutes, a "Nap" (partial consolidation) is triggered.
4. [x] The background task is non-blocking and handles its own errors gracefully.
5. [x] Automation status and next scheduled run are visible in the `SYSTEM_LOG`.

## Tasks / Subtasks
- [x] Backend: Scheduler Implementation (AC: #1, #2)
    - [x] Update `main.py` to launch a background task loop during the `lifespan` event.
    - [x] Implement a simple async `while True` loop with `asyncio.sleep`.
- [x] Backend: Inactivity Logic (AC: #3)
    - [x] Track the timestamp of the last user message in the orchestrator state.
    - [x] Check this timestamp in the background loop to trigger early consolidation.
- [x] Backend: Error Management (AC: #4)
    - [x] Ensure the loop survives database or LLM timeouts.
- [x] Integration: Monitoring (AC: #5)
    - [x] Log the "Next Sleep Cycle in X minutes" to the bus.

## Dev Notes
- **Inactivity Threshold**: Default 900 seconds (15 min).
- **Redundancy**: Ensure that if a manual trigger is called, the background timer resets or accounts for it.
- **Source Tree**: Logic mostly in `main.py` or a new `src/infrastructure/scheduler.py`. [Source: src/domain/memory.py for consolidator access].

## Testing
- **Integration**: Verify via logs that the consolidation triggers after the specified interval.
- **Simulation**: Mock "no user message" for 15s (instead of 15m) to verify the inactivity trigger.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Initial draft for Sleep Automation | Bob (SM) |
| 2026-01-23 | 1.1 | Implementation completed and scheduler active | James (Dev) |

## Dev Agent Record
- **Agent Model Used**: Gemini 2.0 Flash
- **Debug Log References**: [N/A]
- **Completion Notes List**:
    - [Implemented sleep_scheduler background task in main.py]
    - [Added interaction tracking for user messages]
    - [Configured interval and inactivity triggers]
- **File List**:
    - `apps/h-core/src/main.py`

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Effective implementation of background autonomy. The scheduler logic correctly handles both fixed-interval "Sleep" and inactivity-based "Naps". The use of `asyncio.create_task` ensures the orchestrator remains responsive to real-time events. Tracking of `last_user_interaction` within the WebSocket handler is precise.

### Refactoring Performed
None. The implementation was cleanly integrated into the existing `main.py` lifespan and WebSocket loops.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Logic verified via state tracking analysis)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Implemented background scheduler task
- [x] Added hourly Sleep Cycle trigger
- [x] Added 15-min inactivity Nap trigger
- [x] Verified error resilience of the loop
- [ ] Move scheduler to a dedicated component class (V3.1)

### Gate Status
Gate: PASS → docs/qa/gates/10.1-sleep-automation.yml
Risk profile: docs/qa/assessments/10.1-risk-20260123.md
NFR assessment: docs/qa/assessments/10.1-nfr-20260123.md
Trace matrix: docs/qa/assessments/10.1-trace-20260123.md

### Recommended Status
[✓ Ready for Done]