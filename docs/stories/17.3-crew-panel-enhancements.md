# Story 17.3: Crew Panel Enhancements (Tokens & Status)

**Status:** Ready for Review
**Epic:** 17 - "The Stage" UI/UX Overhaul

## Story
**As a** User,
**I want** detailed metrics about my agents in the Crew Panel,
**so that** I can monitor their consumption (tokens) and manage their active state easily.

## Acceptance Criteria
1. **Token Consumption:**
    - Display a "Tokens Used" counter on each agent card.
    - Start with a mocked value or pull from `LiteLLM` logs if feasible (best effort).
2. **Active State Toggle:**
    - Ensure the existing "Active/Sleep" toggle switch is robust and properly labeled.
    - Disabling an agent must visually dim the card.
3. **Agent Details:**
    - Show "Tools Available" as a list of tags.
    - Show "Current Emotion" (e.g., 'Happy', 'Pensive').

## Tasks / Subtasks
- [x] Backend: Update `AgentConfig` or `AgentContext` to track token usage (requires LLM client update to return usage stats).
- [x] Backend: Include token stats in `api/agents` or periodic broadcast.
- [x] Frontend: Update `Renderer.renderAgentGrid` to display the new metrics.
- [x] Frontend: Style the token counter (e.g., small badge).

## Dev Notes
- **LiteLLM:** Returns usage stats in the response object (`response.usage.total_tokens`). We need to capture this in `BaseAgent` and store it in `AgentContext`.

## Testing
- **Scenarios:**
    - Send a message to Lisa.
    - Check Crew Panel: Lisa's token count should increase.
    - Toggle Lisa to OFF. Send message. Lisa should not respond (verified by Story 12.5 logic, but verify UI reflects state).

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Initial draft for Crew Enhancements | Bob (SM) |
| 2026-01-26 | 1.1 | Implemented Token Tracking and UI | James (Dev) |

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `tests/validate_17_3.py` passed.

### Completion Notes List
- Implemented differentiated token tracking (Prompt, Completion, Total) in `AgentContext`.
- Updated `BaseAgent._process_narrative` to extract specific usage metrics from LiteLLM response with robust fallback for different response formats.
- Exposed `prompt_tokens`, `completion_tokens`, and `total_tokens` via `/api/agents` endpoint.
- Updated `network.js` and `renderer.js` to display the breakdown (↑ for IN, ↓ for OUT, Σ for TOTAL) in agent cards.
- Added logging in backend to trace token usage per interaction.
- Verified fix with updated `tests/validate_17_3.py`.

### File List
- `apps/h-core/src/domain/agent.py`
- `apps/h-core/src/main.py`
- `apps/a2ui/js/network.js`
- `apps/a2ui/js/renderer.js`
- `apps/a2ui/style.css`
- `tests/validate_17_3.py`

## QA Results

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
L'implémentation est d'excellente qualité. L'utilisation d'une logique d'extraction multi-format pour les tokens LiteLLM (dict, pydantic model, attributes) garantit une grande résilience face aux changements de fournisseurs de LLM. La différenciation Prompt/Completion/Total apporte une granularité d'observabilité supérieure aux attentes initiales.

### Refactoring Performed
Aucun refactoring direct nécessaire, le code produit par James est déjà conforme aux standards et bien structuré. L'ajout de logs de debug (`TOKEN_DEBUG`, `TOKEN_SYNC`) facilite grandement la testabilité et le monitoring.

### Compliance Check
- Coding Standards: [✓] Respect de l'asynchronicité et de la structure du domaine.
- Project Structure: [✓] Intégration parfaite dans `BaseAgent` et `AgentContext`.
- Testing Strategy: [✓] Tests de validation présents et concluants.
- All ACs Met: [✓] Toutes les AC sont validées avec des bonus de précision (tokens).

### Improvements Checklist
- [x] Extraction robuste des tokens LiteLLM.
- [x] Synchronisation continue du UI via les status updates.
- [x] Affichage détaillé des tokens (IN/OUT/TOTAL) dans le Crew Panel.
- [x] Gestion des humeurs et capacités (tags).

### Security Review
Aucun risque de sécurité identifié. Les données de tokens sont purement informatives et locales au contexte de l'agent.

### Performance Considerations
L'accumulation des tokens dans `AgentContext` est une opération O(1) sans impact notable sur la performance. La fréquence des broadcasts de status est raisonnable.

### Files Modified During Review
Aucun.

### Gate Status
Gate: PASS → docs/qa/gates/17.3-crew-panel-enhancements.yml

### Recommended Status
[✓ Ready for Done]

## Status
Done
