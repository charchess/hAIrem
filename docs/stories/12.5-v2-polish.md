# Story 12.5: V2 Polish (Logs, Timestamps, Addressing)

**Status:** Done
**Epic:** 12 - Stabilization & UI Polish

## Story
**As a** User,
**I want** a more refined chat experience and better system observability,
**so that** I can follow conversations precisely and debug the system effectively.

## Acceptance Criteria
1.  **Chat Timestamps:** Every message bubble in the UI must display a small, unobtrusive timestamp (HH:MM).
2.  **Natural Addressing:**
    - If a user message starts with `@AgentName` or `AgentName,`, ONLY that agent should respond.
    - Other agents should receive the message but remain silent (internally logging "Ignored due to addressing").
    - If no specific address is used, standard behavior applies (all active agents may respond, subject to future speech queue logic).
3.  **Configurable Logs:**
    - Add `LOG_LEVEL` to `.env`.
    - `RedisClient` and `BaseAgent` should respect this level before broadcasting `SYSTEM_LOG` messages.
4.  **Internal Broadcast:**
    - Update the `send_internal_note` tool description to explicitly allow `target_agent='broadcast'`.

## Tasks
- [x] Frontend: Update `renderer.js` and `style.css` for timestamps.
- [x] Backend: Implement `_check_addressing(content)` in `BaseAgent.on_message`.
- [x] Backend: Implement Log Level filtering in `main.py` or `logger` config.
- [x] Backend: Update tool docstring in `BaseAgent`.
- [x] Bugfix: Dieu (Entropy Agent) responded to user messages, hiding avatars. Fixed by renaming class to `Agent` and adding explicit ignore rule.
- [x] Bugfix: Dashboard discovery improved via startup broadcast.
- [x] Bugfix: Missing assets fallback to neutral to avoid disappearing avatars.
- [x] Bugfix: Restored missing SurrealDB methods (`semantic_search`, `insert_memory`, etc.) to fix RAG.

## Testing Scenarios
- [x] **Timestamp:** Verify bubbles have a time span (e.g., '14:30').
- [x] **Addressing:**
    - Send '@Lisa hello'. Verify ONLY Lisa responds.
    - Send 'Lisa, hello'. Verify ONLY Lisa responds.
    - Send 'Hello'. Verify all active agents process it.
    - Send 'Bonjour a Lisa'. Verify ONLY Lisa responds (Natural Addressing).
- [x] **Logs:**
    - Set LOG_LEVEL=ERROR. Verify INFO logs are filtered out.
- [x] **Internal Note:**
    - Verify 'send_internal_note' works with target='broadcast'.

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- `apps/h-core/tests/test_polish_v2.py` passed.
- E2E Log analysis confirmed `Agent Renarde ignored message from user due to addressing`.
- Playwright check confirmed 4 agent cards in dashboard.
- RAG tool call `recall_memory` verified without SurrealDB attribute errors.

### Completion Notes List
- Implemented UI timestamps in chat bubbles with CSS styling.
- Added natural addressing filtering in `BaseAgent` using word-boundary regex (@Name, Name,, "à Name").
- Implemented `RedisLogHandler` with `LOG_LEVEL` support in `main.py`.
- Fixed `send_internal_note` to support `broadcast` target and updated docstring.
- Prevented Dieu (Entropy Agent) from responding to user messages by correctly loading its custom class.
- Added startup presence broadcast for all agents to fix dashboard visibility.
- Implemented asset loading fallback in `Renderer` to prevent avatar disappearance.
- Restored `SurrealDbClient` methods required for RAG and Memory Consolidation.

### File List
- `apps/a2ui/js/renderer.js`
- `apps/a2ui/style.css`
- `apps/h-core/src/main.py`
- `apps/h-core/src/domain/agent.py`
- `apps/h-core/src/domain/memory.py`
- `apps/h-core/src/infrastructure/surrealdb.py`
- `agents/entropy/logic.py`
- `agents/lisa/logic.py`
- `.env`
- `apps/h-core/tests/test_polish_v2.py`

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-25 | 1.0 | Implemented polish features and fixes | James (Dev) |
| 2026-01-25 | 1.1 | Fixed addressing, dashboard discovery, RAG methods and Dieu logic | James (Dev) |

## QA Results



### Review Date: 2026-01-25

### Reviewed By: Quinn (Test Architect)



### Code Quality Assessment

Excellent recovery. The developer went beyond the initial scope to fix critical regressions in the RAG system and agent loading lifecycle. The addressing logic is now naturally intuitive and highly effective at reducing LLM noise.



### Compliance Check

- Coding Standards: [✓]

- Project Structure: [✓]

- Testing Strategy: [✓] (Unit tests cover natural language addressing)

- All ACs Met: [✓]



### Gate Status

Gate: PASS → docs/qa/gates/12.5-v2-polish.yml

Risk profile: N/A (Polish pass)

NFR assessment: PASS (Observability & Reliability significantly improved)



### Recommended Status

**Status:** Done
