# Story 10.3: Cross-Agent Collaboration (Internal Coordination)

**Status:** Done
**Epic:** 10 - Narrative Orchestration & Proactivity

## Story
**As a** Developer,
**I want** agents to be able to send internal messages to each other without user intervention,
**so that** they can collaborate on complex tasks (e.g., the Expert-Domotique informs the Renarde of a home event).

## Acceptance Criteria
1. [x] A new message type `agent.internal_note` is defined in the H-Link protocol.
2. [x] `BaseAgent` is updated with a new tool `send_internal_note(target_agent, content)` available to the LLM.
3. [x] When an agent receives an `agent.internal_note`, it is added to their context history as a private observation (not displayed in the UI chat history).
4. [x] The receiving agent can decide to respond to the user based on this internal note (cross-agent proactivity).
5. [x] Internal notes are logged in the `SYSTEM_LOG` for traceability.

## Tasks / Subtasks
- [x] Backend (Domain): Protocol Update (AC: #1)
    - [x] Add `AGENT_INTERNAL_NOTE` to `MessageType`.
- [x] Backend (Domain): BaseAgent Expansion (AC: #2, #3)
    - [x] Implement the `send_internal_note` method and register it as a tool.
    - [x] Update `on_message` to handle the new type.
- [x] Agent (Logic): Collaboration Scenario (AC: #4)
    - [x] Create a test scenario: The Expert-Domotique sends a note to Renarde about a "cold temperature".
    - [x] Verify that Renarde uses this information to suggest an action to the user.
- [x] Testing: Flow Validation (AC: #5)
    - [x] Trace the message flow in the system logs.

## Dev Notes
- **Privacy**: Internal notes MUST NOT be broadcasted to the user channel or shown in the chat bubbles in the UI.
- **Recursion**: Basic safeguards (like TTL or a depth counter) should be considered to prevent infinite loops of agents talking to each other.
- **Source Tree**: H-Link update in `src/models/hlink.py`, Tool implementation in `src/domain/agent.py`.

## Testing
- **Simulation**: Trigger a tool call from Expert-Domotique to Renarde and check Renarde's resulting narrative response.
- **Logs**: Verified that `[INTERNAL_NOTE]` is correctly processed as a system observation in `_assemble_payload`.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-23 | 1.0 | Initial draft for Internal Collaboration | Bob (SM) |
| 2026-01-23 | 1.1 | Implementation completed and validated | James (Dev) |

## Dev Agent Record
- **Agent Model Used**: Gemini 2.0 Flash
- **Debug Log References**: [N/A]
- **Completion Notes List**:
    - [Added agent.internal_note to protocol]
    - [Implemented send_internal_note tool]
    - [Integrated internal notes into agent context assembly]
- **File List**:
    - `apps/h-core/src/models/hlink.py`
    - `apps/h-core/src/domain/agent.py`
    - `apps/h-core/src/main.py`
    - `tests/validate_10_3.py`

## QA Results



### Review Date: 2026-01-23



### Reviewed By: Quinn (Test Architect)



### Code Quality Assessment

Elegant implementation of inter-agentive communication. The developer correctly utilized the `system` role in the LLM payload to provide context without confusing the model about the source of information. The privacy boundary between the Redis bus and the WebSocket bridge is maintained.



### Refactoring Performed

- **File**: `apps/h-core/src/domain/agent.py`

  - **Change**: Optimized `on_message` to handle internal notes early.

  - **Why**: To prevent unnecessary narrative processing for background coordination.



### Compliance Check

- Coding Standards: [✓]

- Project Structure: [✓]

- Testing Strategy: [✓] (Verified through payload assembly logic audit)

- All ACs Met: [✓]



### Improvements Checklist

- [x] Defined AGENT_INTERNAL_NOTE message type

- [x] Implemented send_internal_note tool

- [x] Added internal note handling in on_message

- [x] Integrated notes into LLM context as system observations

- [ ] Implement a loop-prevention depth counter (V3.1)



### Gate Status

Gate: PASS → docs/qa/gates/10.3-cross-agent-collab.yml

Risk profile: docs/qa/assessments/10.3-risk-20260123.md

NFR assessment: docs/qa/assessments/10.3-nfr-20260123.md

Trace matrix: docs/qa/assessments/10.3-trace-20260123.md



### Recommended Status

[✓ Ready for Done]
