services:
  redis:
    image: redis:7-alpine
    ports:
      - "6377:6379"
    volumes:
      - redis_data:/data
    networks:
      - hairem-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  surrealdb:
    image: surrealdb/surrealdb:latest
    ports:
      - "8002:8000"
    command: start --user root --pass root rocksdb:/mydata
    volumes:
      - ./surreal_data:/mydata
    networks:
      - hairem-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - hairem-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 4G

  h-core:
    build:
      context: ./apps/h-core
      dockerfile: Dockerfile
    env_file:
      - .env
    volumes:
      - ./apps/h-core/src:/app/src
      - ./agents:/app/agents
      - ./config/visual:/app/config/visual
      - ./config/proactivity:/app/config/proactivity
      - /media/generated:/media/generated
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SURREALDB_URL=ws://surrealdb:8000/rpc
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      - NANOBANANA_BASE_URL=http://h-bridge:8000
      - PROACTIVITY_CONFIG=/app/config/proactivity/triggers.yaml
      - VISUAL_CONFIG_DIR=/app/config/visual
      - MEDIA_OUTPUT_PATH=/media/generated
      - AGENTS_PATH=/app/agents
    depends_on:
      redis:
        condition: service_healthy
      surrealdb:
        condition: service_started
      ollama:
        condition: service_started
    networks:
      - hairem-net

  h-bridge:
    build:
      context: ./apps/h-bridge
      dockerfile: Dockerfile
    env_file:
      - .env
    volumes:
      - ./apps/h-bridge/src:/app/src
      - ./apps/h-bridge/static:/app/static
      - ./apps/h-bridge/models:/app/models
      - ./apps/h-core/src:/app/h-core/src
      - ./agents:/app/agents
      - /media/generated:/media/generated
      - hf_cache:/root/.cache/huggingface
    environment:
      - REDIS_HOST=redis
      - SURREALDB_URL=ws://surrealdb:8000/rpc
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      - DEBUG=1
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - hairem-net

networks:
  hairem-net:
    driver: bridge

volumes:
  redis_data:
  hf_cache:
  ollama_data:
